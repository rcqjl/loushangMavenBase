
L5.grid.GridPanel=L5.extend(L5.Panel,{ddText:"{0} selected row{1}",dataLoadingText:"Data loading...",minColumnWidth:25,trackMouseOver:false,enableScollGridView:false,notSelectFirstRow:false,isGrid:true,enableDragDrop:false,enableColumnMove:false,enableColumnHide:false,enableHdMenu:false,stripeRows:false,autoExpandColumn:false,autoExpandMin:50,autoExpandMax:1000,view:null,loadMask:true,deferRowRender:false,rendered:false,viewReady:false,stateEvents:["columnmove","columnresize","sortchange"],assistWin:false,clicksToAssistWin:2,unselect:true,enableHeaderFloat:false,headerY:0,initComponent:function(){L5.grid.GridPanel.superclass.initComponent.call(this);this.autoScroll=false;this.autoWidth=false;if(L5.isArray(this.columns)){this.colModel=new L5.grid.ColumnModel(this.columns,this);delete this.columns;}
if(this.ds){this.dataset=this.ds;delete this.ds;}
if(this.cm){this.colModel=this.cm;delete this.cm;}
if(this.sm){this.selModel=this.sm;delete this.sm;}
this.dataset=L5.DatasetMgr.lookup(this.dataset);this.addEvents("click","dblclick","contextmenu","mousedown","mouseup","mouseover","mouseout","keypress","keydown","cellmousedown","rowmousedown","headermousedown","cellclick","celldblclick","rowclick","rowdblclick","headerclick","headerdblclick","rowcontextmenu","cellcontextmenu","headercontextmenu","bodyscroll","columnresize","columnmove","sortchange");},onRender:function(ct,position){L5.grid.GridPanel.superclass.onRender.apply(this,arguments);var c=this.body;if(this.loadMask){this.loadMask=new L5.LoadMask(this.bwrap,{msg:this.dataLoadingText,dataset:this.dataset});}
this.el.addClass('l-grid-panel');c.setWidth("100%");var view=this.getView();view.init(this);c.on("mousedown",this.onMouseDown,this);c.on("click",this.onClick,this);c.on("dblclick",this.onDblClick,this);c.on("contextmenu",this.onContextMenu,this);c.on("keydown",this.onKeyDown,this);this.relayEvents(c,["mousedown","mouseup","mouseover","mouseout","keypress"]);this.getSelectionModel().init(this);this.view.render();if(this.enableHeaderFloat){if(this.enableFloat)
this.headerY=this.tbar.getY();else
this.headerY=this.tbar.getY()+this.tbar.getHeight();L5.fly(window).on('scroll',this.enableFloatForHeader.createDelegate(this,[c.dom.firstChild.firstChild.firstChild]));}
if(this.bbar&&this.bottomToolbar){this.bottomToolbar.render(this.bbar);this.bottomToolbar.ownerCt=this;}
this.dataset.on('load',this.refreshBody,this);},refreshBody:function(){this.view.refresh(true);},initEvents:function(){L5.grid.GridPanel.superclass.initEvents.call(this);if(this.assistWin){this.initShowWin();if(this.clicksToAssistWin==2){this.on("rowdblclick",this.ShowWin,this);}else{this.on("rowclick",this.ShowWin,this);}}
if(this.loadMask){this.loadMask=new L5.LoadMask(this.bwrap,L5.apply({dataset:this.dataset},this.loadMask));}},initShowWin:function(){var title=this.title?this.title:"";var renderEl=this.el.dom;if(!L5.Window)
return;var g=this;this.assistWindow=new L5.Window({title:title,resizable:true,autoScroll:true,width:400,plain:true,shim:true,renderTo:renderEl,closeAction:'hide',closable:false,layout:'fit',tools:[{id:'hidewin',handler:function(event,toolEl,win){g.stopEditing();win.hide();}}]});},ShowWin:function(grid,rowIndex,e){var win=this.assistWindow;if(win){var rowstr="";var height=0;var l=this.colModel.config.length;for(var col=0;col<l;col++){if(!this.colModel.isHidden(col)){var cfg=this.colModel.config[col];if(cfg.field&&cfg.hidden!=true){height++;rowstr+=this.createTrFormCm(cfg,rowIndex,col);}}}
height>9?win.setHeight(305):win.setHeight(height*30+35);var dsid=this.dataset.id;var htmlStr='<form class="L5Form" dataset="'+dsid+'">'+'<table border="0" cellspacing="0" cellpadding="0" width="100%"><tbody>'+
rowstr+'</tbody></table>'+'</form>';win.show();win.body.update(htmlStr);}},createTrFormCm:function(cfg,row,col){var str="";str='<tr><td  style="width:50%;" class="FieldLabel"><label>'
+cfg.header
+':</label></td><td  style="width:50%;" class="FieldInput">'
+this.createEl4Win(cfg,row,col);+'</td></tr>';return str;},createEl4Win:function(cfg,row,col){var value=this.getView().getCell(row,col).childNodes[0].innerHTML;var str='<label>'+value+'</label>';return str;},initStateEvents:function(){L5.grid.GridPanel.superclass.initStateEvents.call(this);this.colModel.on('hiddenchange',this.saveState,this,{delay:100});},applyState:function(state){var cm=this.colModel;var cs=state.columns;if(cs){for(var i=0,len=cs.length;i<len;i++){var s=cs[i];var c=cm.getColumnById(s.id);if(c){c.hidden=s.hidden;c.width=s.width;var oldIndex=cm.getIndexById(s.id);if(oldIndex!=i){cm.moveColumn(oldIndex,i);}}}}
if(state.sort){this.dataset[this.dataset.remoteSort?'setDefaultSort':'sort'](state.sort.field,state.sort.direction);}},getState:function(){var o={columns:[]};for(var i=0,c;c=this.colModel.config[i];i++){o.columns[i]={id:c.id,width:c.width};if(c.hidden){o.columns[i].hidden=true;}}
var ss=this.dataset.getSortState();if(ss){o.sort=ss;}
return o;},afterRender:function(){L5.grid.GridPanel.superclass.afterRender.call(this);this.view.layout();if(this.deferRowRender){this.view.afterRender.defer(10,this.view);}else{this.view.afterRender();}
if(this.bbar&&this.bottomToolbar){this.bottomToolbar.render(this.bbar);this.bottomToolbar.ownerCt=this;}
this.viewReady=true;},reconfigure:function(dataset,colModel){if(this.loadMask){this.loadMask.destroy();this.loadMask=new L5.LoadMask(this.bwrap,L5.apply({dataset:dataset},this.initialConfig.loadMask));}
this.view.bind(dataset,colModel);this.dataset=dataset;this.colModel=colModel;if(this.rendered){this.view.refresh(true);}},onKeyDown:function(e){this.fireEvent("keydown",e);},onDestroy:function(){if(this.rendered){if(this.loadMask){this.loadMask.destroy();}
var c=this.body;c.removeAllListeners();this.view.destroy();c.update("");}
this.colModel.purgeListeners();L5.grid.GridPanel.superclass.onDestroy.call(this);},processEvent:function(name,e){this.fireEvent(name,e);var t=e.getTarget();var v=this.view;var header=v.findHeaderIndex(t);if(header!==false){this.fireEvent("header"+name,this,header,e);}else{var row=v.findRowIndex(t);var cell=v.findCellIndex(t);if(row!==false){this.fireEvent("row"+name,this,row,e);if(cell!==false){this.fireEvent("cell"+name,this,row,cell,e);}}}},onClick:function(e){this.processEvent("click",e);},onMouseDown:function(e){this.processEvent("mousedown",e);},onContextMenu:function(e,t){this.processEvent("contextmenu",e);},onDblClick:function(e){this.processEvent("dblclick",e);},walkCells:function(row,col,step,fn,scope){var cm=this.colModel,clen=cm.getColumnCount();var ds=this.dataset,rlen=ds.getCount(),first=true;if(step<0){if(col<0){row--;first=false;}
while(row>=0){if(!first){col=clen-1;}
first=false;while(col>=0){if(fn.call(scope||this,row,col,cm)===true){return[row,col];}
col--;}
row--;}}else{if(col>=clen){row++;first=false;}
while(row<rlen){if(!first){col=0;}
first=false;while(col<clen){if(fn.call(scope||this,row,col,cm)===true){return[row,col];}
col++;}
row++;}}
return null;},getSelections:function(){return this.selModel.getSelections();},onResize:function(){L5.grid.GridPanel.superclass.onResize.apply(this,arguments);if(this.viewReady){this.view.layout();}},getGridEl:function(){return this.body;},stopEditing:L5.emptyFn,getSelectionModel:function(){if(!this.selModel){this.selModel=new L5.grid.RowSelectionModel(this.disableSelection?{selectRow:L5.emptyFn}:(this.rowselect?{listeners:{'rowselect':this.rowselect}}:null));}else{if(this.rowselect)
this.selModel.addListener('rowselect',this.rowselect);}
return this.selModel;},getDataset:function(){return this.dataset;},getColumnModel:function(){return this.colModel;},getView:function(){if(!this.view){if(this.enableScollGridView)
this.view=new L5.grid.ScollGridView(this.viewConfig);else
this.view=new L5.grid.GridView(this.viewConfig);}
return this.view;},getDragDropText:function(){var count=this.selModel.getCount();return String.format(this.ddText,count,count==1?'':'s');},enableFloatForHeader:function(ghostDiv){if(ghostDiv!=null){var divObjHeight=this.tbar.getHeight();var hiddenWhenY=this.headerY+this.height-divObjHeight;var scrollY=document.body.scrollTop||window.pageYOffset||document.documentElement.scrollTop||0;if(this.headerY>=scrollY||scrollY>=hiddenWhenY){ghostDiv.style.position="static";ghostDiv.style.top=this.headerY;}else{ghostDiv.style.zIndex=1000000;ghostDiv.style.display="block";if(ghostDiv.style.position!="fixed"){ghostDiv.style.position="fixed";if(this.enableFloat)
ghostDiv.style.top=divObjHeight+"px";else
ghostDiv.style.top=0;}
ghostDiv.firstChild.style.width=ghostDiv.parentNode.parentNode.style.width;}}}});L5.reg('grid',L5.grid.GridPanel);

L5.grid.GridView=function(config){L5.apply(this,config);this.addEvents("beforerowremoved","beforerowsinserted","beforerefresh","rowremoved","rowsinserted","rowupdated","refresh");L5.grid.GridView.superclass.constructor.call(this);};L5.extend(L5.grid.GridView,L5.util.Observable,{deferEmptyText:true,scrollOffset:19,autoFill:false,forceFit:false,sortClasses:["sort-asc","sort-desc"],sortAscText:"Sort Ascending",sortDescText:"Sort Descending",columnsText:"Columns",msgLabelWithHeader:'The {0}th row [{1}] column {2}',borderWidth:2,tdClass:'l-grid3-cell',hdCls:'l-grid3-hd',cellSelectorDepth:4,rowSelectorDepth:10,cellSelector:'td.l-grid3-cell',rowSelector:'div.l-grid3-row',unselect:true,initTemplates:function(){var ts=this.templates||{};if(!ts.master){ts.master=new L5.Template('<div class="l-grid3" hidefocus="true">','<div class="l-grid3-viewport">','<div class="l-grid3-header"><div class="l-grid3-header-inner"><div class="l-grid3-header-offset">{header}</div></div><div class="l-clear"></div></div>','<div class="l-grid3-scroller"><div class="l-grid3-body" style="{bodywidth}">{body}</div><a href="#" class="l-grid3-focus" tabIndex="-1"></a></div>',this.renderSum?'{sum}':'',"</div>",'<div class="l-grid3-resize-marker">&#160;</div>','<div class="l-grid3-resize-proxy">&#160;</div>',"</div>");}
if(!ts.header){ts.header=new L5.Template('<table border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<thead><tr class="l-grid3-hd-row">{cells}</tr></thead>',"</table>");}
if(!ts.hcell){ts.hcell=new L5.Template('<td class="l-grid3-hd l-grid3-cell l-grid3-td-{id} {css}" style="{style}"><div {tooltip} {attr} class="l-grid3-hd-inner l-grid3-hd-{id}" unselectable="on" style="{istyle}">',this.grid.enableHdMenu?'<a class="l-grid3-hd-btn" href="#"></a>':'','{value}<img class="l-grid3-sort-icon" src="',L5.BLANK_IMAGE_URL,'" />',"</div></td>");}
if(!ts.body){ts.body=new L5.Template('{rows}');}
if(!ts.row){ts.row=new L5.Template('<div class="l-grid3-row {alt}" style="{tstyle}"><table class="l-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<tbody><tr>{cells}</tr>',(this.enableRowBody?'<tr class="l-grid3-row-body-tr" style="{bodyStyle}"><td colspan="{cols}" class="l-grid3-body-cell" tabIndex="0" hidefocus="on"><div class="l-grid3-row-body">{body}</div></td></tr>':''),'</tbody></table></div>');}
if(!ts.cell){var divTmp='<div title="{valueTip}"  class="l-grid3-cell-inner l-grid3-col-{id}"';if(this.unselect)
divTmp+=' unselectable="on"';divTmp+=' {attr}>{value}</div>';ts.cell=new L5.Template('<td class="l-grid3-col l-grid3-cell l-grid3-td-{id} {css}" style="{style}" tabIndex="0" {cellAttr}>',divTmp,"</td>");}
for(var k in ts){var t=ts[k];if(t&&typeof t.compile=='function'&&!t.compiled){t.disableFormats=true;t.compile();}}
this.templates=ts;this.colRe=new RegExp("l-grid3-td-([^\\s]+)","");},fly:function(el){if(!this._flyweight){this._flyweight=new L5.Element.Flyweight(document.body);}
this._flyweight.dom=el;return this._flyweight;},getEditorParent:function(){return this.scroller.dom;},initElements:function(){var E=L5.Element;var el=this.grid.getGridEl().dom.firstChild;var cs=el.childNodes;this.el=new E(el);this.mainWrap=new E(cs[0]);this.mainHd=new E(this.mainWrap.dom.firstChild);if(this.renderSum){this.mainSum=new E(this.mainWrap.dom.childNodes[2]);this.sumBody=new E(this.mainSum.dom.firstChild.firstChild.rows[0]);}
if(this.grid.hideHeaders){this.mainHd.setDisplayed(false);}
this.innerHd=this.mainHd.dom.firstChild;this.offsetHd=this.mainHd.dom.firstChild.firstChild;this.scroller=new E(this.mainWrap.dom.childNodes[1]);if(this.forceFit){this.scroller.setStyle('overflow-x','hidden');}
this.mainBody=new E(this.scroller.dom.firstChild);this.focusEl=new E(this.scroller.dom.childNodes[1]);this.focusEl.swallowEvent("click",true);this.resizeMarker=new E(cs[1]);this.resizeProxy=new E(cs[2]);},getRows:function(){return this.hasRows()?this.mainBody.dom.childNodes:[];},findCell:function(el){if(!el){return false;}
return this.fly(el).findParent(this.cellSelector,this.cellSelectorDepth);},findCellIndex:function(el,requiredCls){var cell=this.findCell(el);if(cell&&(!requiredCls||this.fly(cell).hasClass(requiredCls))){return this.getCellIndex(cell);}
return false;},getCellIndex:function(el){if(el){var m=el.className.match(this.colRe);if(m&&m[1]){return this.cm.getIndexById(m[1]);}}
return false;},findHeaderCell:function(el){var cell=this.findCell(el);return cell&&this.fly(cell).hasClass(this.hdCls)?cell:null;},findHeaderIndex:function(el){return this.findCellIndex(el,this.hdCls);},findRow:function(el){if(!el){return false;}
return this.fly(el).findParent(this.rowSelector,this.rowSelectorDepth);},findRowIndex:function(el){var r=this.findRow(el);return r?r.rowIndex:false;},getRow:function(row){return this.getRows()[row];},getCell:function(row,col){if(this.getRow(row))
return this.getRow(row).getElementsByTagName('td')[col];},getHeaderCell:function(index){return this.mainHd.dom.getElementsByTagName('td')[index];},addRowClass:function(row,cls){var r=this.getRow(row);if(r){this.fly(r).addClass(cls);}},toggleRowClass:function(row,cls){var r=this.getRow(row);if(r){if(this.fly(r).hasClass(cls)){this.fly(r).removeClass(cls);}else{this.removeRowClass(this.lastToggleRow,cls);this.fly(r).addClass(cls);this.ds.moveTo(row);this.lastToggleRow=row;}}},removeRowClass:function(row,cls){var r=this.getRow(row);if(r){this.fly(r).removeClass(cls);}},removeRow:function(row){L5.removeNode(this.getRow(row));this.syncFocusEl(row);},removeRows:function(firstRow,lastRow){var bd=this.mainBody.dom;for(var rowIndex=firstRow;rowIndex<=lastRow;rowIndex++){L5.removeNode(bd.childNodes[firstRow]);}
this.syncFocusEl(firstRow);},getScrollState:function(){var sb=this.scroller.dom;return{left:sb.scrollLeft,top:sb.scrollTop};},restoreScroll:function(state){var sb=this.scroller.dom;sb.scrollLeft=state.left;sb.scrollTop=state.top;},scrollToTop:function(){this.scroller.dom.scrollTop=0;this.scroller.dom.scrollLeft=0;},syncScroll:function(){this.syncHeaderScroll();var mb=this.scroller.dom;this.grid.fireEvent("bodyscroll",mb.scrollLeft,mb.scrollTop);},syncHeaderScroll:function(){var mb=this.scroller.dom;this.innerHd.scrollLeft=mb.scrollLeft;this.innerHd.scrollLeft=mb.scrollLeft;},updateSortIcon:function(col,dir){var sc=this.sortClasses;var hds=this.mainHd.select('td').removeClass(sc);hds.item(col).addClass(sc[dir=="DESC"?1:0]);},updateAllColumnWidths:function(){var tw=this.getTotalWidth();var clen=this.cm.getColumnCount();var ws=[];for(var i=0;i<clen;i++){ws[i]=this.getColumnWidth(i);}
this.innerHd.firstChild.firstChild.style.width=tw;for(var i=0;i<clen;i++){var hd=this.getHeaderCell(i);hd.style.width=ws[i];}
var ns=this.getRows(),row,trow;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;trow=row.firstChild.rows[0];for(var j=0;j<clen;j++){trow.childNodes[j].style.width=ws[j];}}}
if(row&&row.parentNode){row.parentNode.style.width=tw;}
this.onAllColumnWidthsUpdated(ws,tw);},updateColumnWidth:function(col,width){var w=this.getColumnWidth(col);var tw=this.getTotalWidth();this.innerHd.firstChild.firstChild.style.width=tw;var hd=this.getHeaderCell(col);hd.style.width=w;var ns=this.getRows(),row;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;row.firstChild.rows[0].childNodes[col].style.width=w;}}
if(row&&row.parentNode){row.parentNode.style.width=tw;}
this.onColumnWidthUpdated(col,w,tw);},updateColumnHidden:function(col,hidden){var tw=this.getTotalWidth();this.innerHd.firstChild.firstChild.style.width=tw;var display=hidden?'none':'';var hd=this.getHeaderCell(col);hd.style.display=display;var ns=this.getRows(),row;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;row.firstChild.rows[0].childNodes[col].style.display=display;}}
if(row&&row.parentNode){row.parentNode.style.width=tw;}
this.onColumnHiddenUpdated(col,hidden,tw);delete this.lastViewWidth;this.layout();},doRender:function(cs,rs,ds,startRow,colCount,stripe){var ts=this.templates,ct=ts.cell,rt=ts.row,last=colCount-1;var tstyle='width:'+this.getTotalWidth()+';';var buf=[],cb,c,p={},rp={tstyle:tstyle},r;for(var j=0,len=rs.length;j<len;j++){r=rs[j];cb=[];var rowIndex=(j+startRow);for(var i=0;i<colCount;i++){c=cs[i];p.id=c.id;p.css=i==0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':'');p.attr=p.cellAttr="";p.value=(""+c.renderer(r.data[c.name],p,r,rowIndex,i,ds,c.name,this.grid)).replace(/\n/g,'<br/>');var vTip=this.cm.config[i].valueTip;if(vTip=="qtip"){if(L5.QuickTips){L5.QuickTips.enable();}
if(L5.isIE){p.attr="L5:qtip"+"='"+p.value.replace(/<br\/>/g,'\n')+"'";}else{p.attr="L5:qtip"+"='"+p.value.replace(/<br\/>/g,'&#13;')+"'";}}
else if(vTip){if(L5.isIE){p.valueTip=p.value.replace(/<br\/>/g,'\n');}else{p.valueTip=p.value.replace(/<br\/>/g,'&#13;');}}else{delete p.valueTip;}
p.style=c.style;if(p.value==undefined||p.value==="")p.value="&#160;";if((r.dirty&&typeof r.modified[c.name]!=='undefined')){p.css+=' l-grid3-dirty-cell';}
L5.Validator.validate(r,c.name,r.data[c.name]);if(r.validate[c.name]!=null){var msgLable=String.format(this.msgLabelWithHeader,(rowIndex+1),c.header,"");if(!r.cellLable)r.cellLable={};r.cellLable[c.name]=msgLable;var msg=String.format(this.msgLabelWithHeader,(rowIndex+1),c.header,r.msg[c.name]);p.css+=' l-grid3-validate-cell';if(L5.QuickTips){L5.QuickTips.enable();}
var errorMsg=L5.valError?L5.valError:"Validate error.";p.attr="L5:qtitle="+errorMsg+" L5:qtip="+msg;}
cb[cb.length]=ct.apply(p);}
var alt=[];if(stripe&&((rowIndex+1)%2==0)){alt[0]="l-grid3-row-alt";}
if(r.dirty){alt[1]=" l-grid3-dirty-row";}
rp.cols=colCount;if(this.getRowClass){alt[2]=this.getRowClass(r,rowIndex,rp,ds);}
rp.alt=alt.join(" ");rp.cells=cb.join("");buf[buf.length]=rt.apply(rp);}
return buf.join("");},processRows:function(startRow,skipStripe){if(this.ds.getCount()<1){return;}
skipStripe=skipStripe||!this.grid.stripeRows;startRow=startRow||0;var rows=this.getRows();var cls=' l-grid3-row-alt ';if(this.grid.isEditor||this.grid.notSelectFirstRow){rows[0].className+=' l-grid3-row-first ';}else{this.grid.getSelectionModel().selectFirstRow();rows[0].className+=' l-grid3-row-first l-grid3-row-selected';}
rows[rows.length-1].className+=' l-grid3-row-last';for(var i=startRow,len=rows.length;i<len;i++){var row=rows[i];row.rowIndex=i;var numbererCell=L5.fly(row).query("div.l-grid3-col-numberer",row);var fileCell=L5.fly(row).query("input.l-form-file",row);if(numbererCell[0]){numbererCell[0].innerHTML=i+1;}
if(fileCell[0]){var oldname=fileCell[0].name;var fieldname=oldname.substring(0,oldname.indexOf('['));var newname=fieldname+'['+i+']';this.ds.getAt(i).set(fieldname,newname);fileCell[0].name=newname;}
if(!skipStripe){var isAlt=((i+1)%2==0);var hasAlt=(' '+row.className+' ').indexOf(cls)!=-1;if(isAlt==hasAlt){continue;}
if(isAlt){row.className+=" l-grid3-row-alt";}else{row.className=row.className.replace("l-grid3-row-alt","");}}}},afterRender:function(){this.mainBody.dom.innerHTML=this.renderRows();this.processRows(0,true);if(this.deferEmptyText!==true){this.applyEmptyText();}},renderUI:function(){var header=this.renderHeaders();var body=this.templates.body.apply({rows:''});var main=null;if(this.renderSum){main={body:body,header:header,bodywidth:'width:'+this.getTotalWidth()+';',sum:this.renderSum()};}else{main={body:body,header:header,bodywidth:'width:'+this.getTotalWidth()+';'};}
var html=this.templates.master.apply(main);var g=this.grid;g.getGridEl().dom.innerHTML=html;this.initElements();L5.fly(this.innerHd).on("click",this.handleHdDown,this);this.mainHd.on("mouseover",this.handleHdOver,this);this.mainHd.on("mouseout",this.handleHdOut,this);this.mainHd.on("mousemove",this.handleHdMove,this);this.scroller.on('scroll',this.syncScroll,this);if(g.enableColumnResize!==false){this.splitZone=new L5.grid.GridView.SplitDragZone(g,this.mainHd.dom);}
if(g.enableColumnMove){this.columnDrag=new L5.grid.GridView.ColumnDragZone(g,this.innerHd);this.columnDrop=new L5.grid.HeaderDropZone(g,this.mainHd.dom);}
if(g.enableHdMenu!==false){if(g.enableColumnHide!==false){this.colMenu=new L5.menu.Menu({id:g.id+"-hcols-menu"});this.colMenu.on("beforeshow",this.beforeColMenuShow,this);this.colMenu.on("itemclick",this.handleHdMenuClick,this);}
this.hmenu=new L5.menu.Menu({id:g.id+"-hctx"});this.hmenu.add({id:"asc",text:this.sortAscText,cls:"xg-hmenu-sort-asc"},{id:"desc",text:this.sortDescText,cls:"xg-hmenu-sort-desc"});if(g.enableColumnHide!==false){this.hmenu.add('-',{id:"columns",text:this.columnsText,menu:this.colMenu,iconCls:'l-cols-icon'});}
this.hmenu.on("itemclick",this.handleHdMenuClick,this);}
if(g.trackMouseOver){this.mainBody.on("mouseover",this.onRowOver,this);this.mainBody.on("mouseout",this.onRowOut,this);}
if(g.enableDragDrop||g.enableDrag){this.dragZone=new L5.grid.GridDragZone(g,{ddGroup:g.ddGroup||'GridDD'});}
this.updateHeaderSortState();},layout:function(){if(!this.mainBody){return;}
var g=this.grid;var c=g.getGridEl();var csize=c.getSize(true);var vw=csize.width;if(vw<20||csize.height<20){return;}
if(g.autoHeight){this.scroller.dom.style.overflow='visible';if(L5.isSafari){this.scroller.dom.style.position='static';}}else{this.el.setSize(csize.width,csize.height);var hdHeight=this.mainHd.getHeight();var vh=csize.height-(hdHeight);this.scroller.setSize(vw,vh);if(this.innerHd){this.innerHd.style.width=(vw-15)+'px';}}
if(this.forceFit){if(this.lastViewWidth!=vw){this.fitColumns(false,false);this.lastViewWidth=vw;}}else{this.autoExpand();this.syncHeaderScroll();}
this.onLayout(vw,vh);},onLayout:function(vw,vh){},onColumnWidthUpdated:function(col,w,tw){this.focusEl.setWidth(tw);},onAllColumnWidthsUpdated:function(ws,tw){this.focusEl.setWidth(tw);},onColumnHiddenUpdated:function(col,hidden,tw){this.focusEl.setWidth(tw);},updateColumnText:function(row,col,text,css,attr){var cell=this.getCell(row,col);if(cell){if(attr==""){cell.firstChild.removeAttribute("L5:qtitle");cell.firstChild.removeAttribute("L5:qtip");}else{if(L5.QuickTips){L5.QuickTips.enable();}
var tp=attr.split(" ");cell.firstChild.setAttribute("L5:qtitle",tp[0].split("=")[1]);cell.firstChild.setAttribute("L5:qtip",tp[1].split("=")[1]);}
if(css.indexOf("l-grid3-dirty-cell")==-1)
L5.fly(cell).removeClass("l-grid3-dirty-cell");if(css.indexOf("l-grid3-validate-cell")==-1)
L5.fly(cell).removeClass("l-grid3-validate-cell");L5.fly(cell).addClass(css);L5.fly(cell).child("div").update(text);var vtip=this.cm.config[col].valueTip;if(vtip){if(vtip=="qtip"){if(L5.QuickTips){L5.QuickTips.enable();}
if(L5.isIE){cell.firstChild.setAttribute("L5:qtip",text.replace(/<br\/>/g,'\n'));}else{cell.firstChild.setAttribute("L5:qtip",text.replace(/<br\/>/g,'&#13;'));}}
else{if(L5.isIE){cell.firstChild.setAttribute("title",text.replace(/<br\/>/g,'\n'));}else{cell.firstChild.setAttribute("title",text.replace(/<br\/>/g,'&#13;'));}}}else{cell.firstChild.removeAttribute("L5:qtip");cell.firstChild.removeAttribute("title");}}},afterMove:function(oldIndex,colIndex){},init:function(grid){this.grid=grid;this.unselect=grid.unselect;this.initTemplates();this.initData(grid.dataset,grid.colModel);this.initUI(grid);},getColumnId:function(index){return this.cm.getColumnId(index);},renderHeaders:function(){var cm=this.cm,ts=this.templates;var ct=ts.hcell;var cb=[],sb=[],p={};var len=cm.getColumnCount();var last=len-1;for(var i=0;i<len;i++){p.id=cm.getColumnId(i);p.value=cm.getColumnHeader(i)||"";p.style=this.getColumnStyle(i,true);p.tooltip=this.getColumnTooltip(i);p.css=i==0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':'');if(cm.config[i].align=='right'){p.istyle='padding-right:16px';}else{delete p.istyle;}
cb[cb.length]=ct.apply(p);}
return ts.header.apply({cells:cb.join(""),tstyle:'width:'+this.getTotalWidth()+';'});},getColumnTooltip:function(i){var tt=this.cm.getColumnTooltip(i);if(tt){if(L5.QuickTips.isEnabled()){return'L5:qtip="'+tt+'"';}else{return'title="'+tt+'"';}}
return"";},beforeUpdate:function(){this.grid.stopEditing(true);},updateHeaders:function(){this.innerHd.firstChild.innerHTML=this.renderHeaders();},focusRow:function(row){this.focusCell(row,0,false);},focusCell:function(row,col,hscroll){this.syncFocusEl(this.ensureVisible(row,col,hscroll));if(L5.isGecko){this.focusEl.focus();}else{this.scroller.focus();}},resolveCell:function(row,col,hscroll){if(typeof row!="number"){row=row.rowIndex;}
if(!this.ds){return null;}
if(row<0||row>=this.ds.getCount()){return null;}
col=(col!==undefined?col:0);var rowEl=this.getRow(row),cellEl;if(!(hscroll===false&&col===0)){while(this.cm.isHidden(col)){col++;}
cellEl=this.getCell(row,col);}
return{row:rowEl,cell:cellEl};},getResolvedXY:function(resolved){if(!resolved){return null;}
var s=this.scroller.dom,c=resolved.cell,r=resolved.row;return c?L5.fly(c).getXY():[this.el.getX(),L5.fly(r).getY()];},syncFocusEl:function(row,col,hscroll){var xy=row;if(!L5.isArray(xy)){row=Math.min(row,Math.max(0,this.getRows().length-1));xy=this.getResolvedXY(this.resolveCell(row,col,hscroll));}
if(xy)
this.focusEl.setY(xy[1]||this.scroller.getXY()[1]);},ensureVisible:function(row,col,hscroll){var resolved=this.resolveCell(row,col,hscroll);if(!resolved||!resolved.row){return;}
var rowEl=resolved.row,cellEl=resolved.cell;var c=this.scroller.dom;var ctop=0;var p=rowEl,stop=this.el.dom;while(p&&p!=stop){ctop+=p.offsetTop;p=p.offsetParent;}
ctop-=this.mainHd.dom.offsetHeight;var cbot=ctop+rowEl.offsetHeight;var ch=c.clientHeight;var stop=parseInt(c.scrollTop,10);var sbot=stop+ch;if(this.grid.scrollFollowSkip){if(ctop<stop){c.scrollTop=ctop;}else if(cbot>sbot){c.scrollTop=cbot-ch;}}
if(hscroll!==false){var cleft=parseInt(cellEl.offsetLeft,10);var cright=cleft+cellEl.offsetWidth;var sleft=parseInt(c.scrollLeft,10);var sright=sleft+c.clientWidth;if(cleft<sleft){c.scrollLeft=cleft;}else if(cright>sright){c.scrollLeft=cright-c.clientWidth;}}
return this.getResolvedXY(resolved);},insertRows:function(dm,firstRow,lastRow,isUpdate){if(!isUpdate&&firstRow===0&&lastRow>=dm.getCount()-1){this.refresh();}else{if(!isUpdate){this.fireEvent("beforerowsinserted",this,firstRow,lastRow);}
var html=this.renderRows(firstRow,lastRow);var before=this.getRow(firstRow);if(before){L5.DomHelper.insertHtml('beforeBegin',before,html);}else{L5.DomHelper.insertHtml('beforeEnd',this.mainBody.dom,html);}
if(!isUpdate){this.fireEvent("rowsinserted",this,firstRow,lastRow);this.processRows(firstRow);}}
this.syncFocusEl(firstRow);},updateRow:function(record,index){var cm=this.cm,colCount=cm.getColumnCount(),last=colCount-1,alt=" l-grid3-dirty-row";for(var i=0;i<colCount;i++){if(cm.isFileColumn(i)){if(!cm.getRenderer(i).doRender)
continue;}
var name=cm.getDataIndex(i);var cellcss='';var attr="";var value=(cm.getRenderer(i)(record.get(name),{},record,index,i,{},name,this.grid)+"").replace(/\n/g,'<br/>');if(value==undefined||value==="")value="&#160;";if(record.dirty&&typeof record.modified[name]!=='undefined'){cellcss+=' l-grid3-dirty-cell';}
L5.Validator.validate(record,name,record.get(name));if(record.validate[name]!=null){var msgLable=String.format(this.msgLabelWithHeader,(index+1),cm.getColumnHeader(i),"");if(!record.cellLable)record.cellLable={};record.cellLable[name]=msgLable;var msg=String.format(this.msgLabelWithHeader,(index+1),cm.getColumnHeader(i),record.msg[name]);cellcss+=' l-grid3-validate-cell';if(L5.QuickTips){L5.QuickTips.enable();}
var errorMsg=L5.valError?L5.valError:"Validate error.";attr="L5:qtitle="+errorMsg+" L5:qtip="+msg;}
this.updateColumnText(index,i,value,cellcss,attr);}},deleteRows:function(dm,firstRow,lastRow){if(dm.getRowCount()<1){this.refresh();}else{this.fireEvent("beforerowsdeleted",this,firstRow,lastRow);this.removeRows(firstRow,lastRow);this.processRows(firstRow);this.fireEvent("rowsdeleted",this,firstRow,lastRow);}},getColumnStyle:function(col,isHeader){var style=!isHeader?(this.cm.config[col].css||''):'';style+='width:'+this.getColumnWidth(col)+';';if(this.cm.isHidden(col)){style+='display:none;';}
var align=this.cm.config[col].align;if(isHeader){align="center";}
if(align){style+='text-align:'+align+';';}
return style;},getColumnWidth:function(col){var w=this.cm.getColumnWidth(col);if(typeof w=='number'){return(L5.isBorderBox?w:(w-this.borderWidth>0?w-this.borderWidth:0))+'px';}else{w=parseInt(w)+"%";}
return w;},getTotalWidth:function(){return isNaN(this.cm.getTotalWidth()/1)?this.cm.getTotalWidth():this.cm.getTotalWidth()+'px';},fitColumns:function(preventRefresh,onlyExpand,omitColumn){var cm=this.cm,leftOver,dist,i;var tw=cm.getTotalWidth(false);var aw=this.grid.getGridEl().getWidth(true)-this.scrollOffset;if(aw<20){return;}
var extra=aw-tw;if(extra===0){return false;}
var vc=cm.getColumnCount(true);var ac=vc-(typeof omitColumn=='number'?1:0);if(ac===0){ac=1;omitColumn=undefined;}
var colCount=cm.getColumnCount();var cols=[];var extraCol=0;var width=0;var w;for(i=0;i<colCount;i++){if(!cm.isHidden(i)&&!cm.isFixed(i)&&i!==omitColumn){w=cm.getColumnWidth(i);cols.push(i);extraCol=i;cols.push(w);width+=w;}}
var frac=(aw-cm.getTotalWidth())/width;while(cols.length){w=cols.pop();i=cols.pop();cm.setColumnWidth(i,Math.max(this.grid.minColumnWidth,Math.floor(w+w*frac)),true);}
if((tw=cm.getTotalWidth(false))>aw){var adjustCol=ac!=vc?omitColumn:extraCol;cm.setColumnWidth(adjustCol,Math.max(1,cm.getColumnWidth(adjustCol)-(tw-aw)),true);}
if(preventRefresh!==true){this.updateAllColumnWidths();}
return true;},autoExpand:function(preventUpdate){var g=this.grid,cm=this.cm;if(!this.userResized&&g.autoExpandColumn){var tw=cm.getTotalWidth(false);var aw=this.grid.getGridEl().getWidth(true)-this.scrollOffset;if(tw!=aw){var ci=cm.getIndexById(g.autoExpandColumn);var currentWidth=cm.getColumnWidth(ci);var cw=Math.min(Math.max(((aw-tw)+currentWidth),g.autoExpandMin),g.autoExpandMax);if(cw>=currentWidth){cm.setColumnWidth(ci,cw,true);if(preventUpdate!==true){this.updateColumnWidth(ci,cw);}}}}},getColumnData:function(){var cs=[],cm=this.cm,colCount=cm.getColumnCount();for(var i=0;i<colCount;i++){var name=cm.getDataIndex(i);cs[i]={header:cm.getColumnHeader(i),name:(typeof name=='undefined'?this.ds.fields.get(i).name:name),renderer:cm.getRenderer(i),id:cm.getColumnId(i),style:this.getColumnStyle(i)};}
return cs;},renderRows:function(startRow,endRow){var g=this.grid,cm=g.colModel,ds=g.dataset,stripe=g.stripeRows;var colCount=cm.getColumnCount();if(ds.getCount()<1){return"";}
var cs=this.getColumnData();startRow=startRow||0;endRow=typeof endRow=="undefined"?ds.getCount()-1:endRow;var rs=ds.getRange(startRow,endRow);return this.doRender(cs,rs,ds,startRow,colCount,stripe);},renderBody:function(){var markup=this.renderRows();return this.templates.body.apply({rows:markup});},refreshRow:function(record){var ds=this.ds,index;if(typeof record=='number'){index=record;record=ds.getAt(index);}else{index=ds.indexOf(record);}
this.updateRow(record,index);this.fireEvent("rowupdated",this,index,record);},refresh:function(headersToo){this.fireEvent("beforerefresh",this);this.grid.stopEditing(true);var result=this.renderBody();this.mainBody.update(result);this.grid.getSelectionModel().clearSelections();if(headersToo===true){this.updateHeaders();this.updateHeaderSortState();}
this.processRows(0,true);this.layout();this.applyEmptyText();this.fireEvent("refresh",this);},applyEmptyText:function(){if(this.emptyText&&!this.hasRows()){this.mainBody.update('<div class="l-grid-empty">'+this.emptyText+'</div>');}},updateHeaderSortState:function(){var state=this.ds.getSortState();if(!state){return;}
if(!this.sortState||(this.sortState.field!=state.field||this.sortState.direction!=state.direction)){this.grid.fireEvent('sortchange',this.grid,state);}
this.sortState=state;var sortColumn=this.cm.findColumnIndex(state.field);if(sortColumn!=-1){var sortDir=state.direction;this.updateSortIcon(sortColumn,sortDir);}},destroy:function(){if(this.colMenu){L5.menu.MenuMgr.unregister(this.colMenu);this.colMenu.destroy();delete this.colMenu;}
if(this.hmenu){L5.menu.MenuMgr.unregister(this.hmenu);this.hmenu.destroy();delete this.hmenu;}
if(this.grid.enableColumnMove){var dds=L5.dd.DDM.ids['gridHeader'+this.grid.getGridEl().id];if(dds){for(var dd in dds){if(!dds[dd].config.isTarget&&dds[dd].dragElId){var elid=dds[dd].dragElId;dds[dd].unreg();L5.get(elid).remove();}else if(dds[dd].config.isTarget){dds[dd].proxyTop.remove();dds[dd].proxyBottom.remove();dds[dd].unreg();}
if(L5.dd.DDM.locationCache[dd]){delete L5.dd.DDM.locationCache[dd];}}
delete L5.dd.DDM.ids['gridHeader'+this.grid.getGridEl().id];}}
if(this.dragZone){this.dragZone.unreg();}
L5.fly(this.innerHd).removeAllListeners();L5.removeNode(this.innerHd);L5.removeNode(this.offsetHd);if(this.sumBody)L5.removeNode(this.sumBody);L5.destroy(this.resizeMarker,this.resizeProxy,this.focusEl,this.mainBody,this.scroller,this.mainHd,this.mainSum,this.mainWrap,this.dragZone,this.splitZone,this.columnDrag,this.columnDrop);this.initData(null,null);L5.EventManager.removeResizeListener(this.onWindowResize,this);this.purgeListeners();},onDenyColumnHide:function(){},render:function(){if(this.autoFill){var ct=this.grid.ownerCt;if(ct&&ct.getLayout()){ct.on('afterlayout',function(){this.fitColumns(true,true);this.updateHeaders();},this,{single:true});}else{this.fitColumns(true,true);}}else if(this.forceFit){this.fitColumns(true,false);}else if(this.grid.autoExpandColumn){this.autoExpand(true);}
this.renderUI();},initData:function(ds,cm){if(this.ds){this.ds.un("load",this.onLoad,this);this.ds.un("datachanged",this.onDataChange,this);this.ds.un("add",this.onAdd,this);this.ds.un("remove",this.onRemove,this);this.ds.un("update",this.onUpdate,this);this.ds.un("clear",this.onClear,this);}
if(ds){ds.on("load",this.onLoad,this);ds.on("datachanged",this.onDataChange,this);ds.on("add",this.onAdd,this);ds.on("remove",this.onRemove,this);ds.on("update",this.onUpdate,this);ds.on("clear",this.onClear,this);}
this.ds=ds;if(this.cm){this.cm.un("configchange",this.onColConfigChange,this);this.cm.un("widthchange",this.onColWidthChange,this);this.cm.un("headerchange",this.onHeaderChange,this);this.cm.un("hiddenchange",this.onHiddenChange,this);this.cm.un("columnmoved",this.onColumnMove,this);this.cm.un("columnlockchange",this.onColumnLock,this);}
if(cm){delete this.lastViewWidth;cm.on("configchange",this.onColConfigChange,this);cm.on("widthchange",this.onColWidthChange,this);cm.on("headerchange",this.onHeaderChange,this);cm.on("hiddenchange",this.onHiddenChange,this);cm.on("columnmoved",this.onColumnMove,this);cm.on("columnlockchange",this.onColumnLock,this);}
this.cm=cm;},onDataChange:function(){this.refresh();this.updateHeaderSortState();this.syncFocusEl(0);},onClear:function(){this.refresh();this.syncFocusEl(0);},onUpdate:function(ds,record){this.refreshRow.defer(1,this,[record]);},onAdd:function(ds,records,index){this.insertRows(ds,index,index+(records.length-1));},onRemove:function(ds,record,index,isUpdate){if(isUpdate!==true){this.fireEvent("beforerowremoved",this,index,record);}
this.removeRow(index);if(isUpdate!==true){this.processRows(index);this.applyEmptyText();this.fireEvent("rowremoved",this,index,record);}},onLoad:function(){this.scrollToTop();},onColWidthChange:function(cm,col,width){this.updateColumnWidth(col,width);},onHeaderChange:function(cm,col,text){this.updateHeaders();},onHiddenChange:function(cm,col,hidden){this.updateColumnHidden(col,hidden);},onColumnMove:function(cm,oldIndex,newIndex){this.indexMap=null;var s=this.getScrollState();this.refresh(true);this.restoreScroll(s);this.afterMove(oldIndex,newIndex);},onColConfigChange:function(){delete this.lastViewWidth;this.indexMap=null;this.refresh(true);},initUI:function(grid){grid.on("headerclick",this.onHeaderClick,this);},initEvents:function(){},onHeaderClick:function(g,index){if(this.headersDisabled||!this.cm.isSortable(index)){return;}
g.stopEditing(true);g.dataset.sort(this.cm.getDataIndex(index));},onRowOver:function(e,t){var row;if((row=this.findRowIndex(t))!==false){this.addRowClass(row,"l-grid3-row-over");}},onRowOut:function(e,t){var row;if((row=this.findRowIndex(t))!==false&&!e.within(this.getRow(row),true)){this.removeRowClass(row,"l-grid3-row-over");}},handleWheel:function(e){e.stopPropagation();},onRowSelect:function(row){this.addRowClass(row,"l-grid3-row-selected");},onRowDeselect:function(row){this.removeRowClass(row,"l-grid3-row-selected");},onCellSelect:function(row,col){var cell=this.getCell(row,col);if(cell){this.fly(cell).addClass("l-grid3-cell-selected");}},onCellDeselect:function(row,col){var cell=this.getCell(row,col);if(cell){this.fly(cell).removeClass("l-grid3-cell-selected");}},onColumnSplitterMoved:function(i,w){this.offsetHd.width='100%';this.userResized=true;var cm=this.grid.colModel;cm.setColumnWidth(i,w,true);if(this.forceFit){this.fitColumns(true,false,i);this.updateAllColumnWidths();}else{this.updateColumnWidth(i,w);this.syncHeaderScroll();}
this.grid.fireEvent("columnresize",i,w);},handleHdMenuClick:function(item){var index=this.hdCtxIndex;var cm=this.cm,ds=this.ds;switch(item.id){case"asc":ds.sort(cm.getDataIndex(index),"ASC");break;case"desc":ds.sort(cm.getDataIndex(index),"DESC");break;default:index=cm.getIndexById(item.id.substr(4));if(index!=-1){if(item.checked&&cm.getColumnsBy(this.isHideableColumn,this).length<=1){this.onDenyColumnHide();return false;}
cm.setHidden(index,item.checked);}}
return true;},isHideableColumn:function(c){return!c.hidden&&!c.fixed;},beforeColMenuShow:function(){var cm=this.cm,colCount=cm.getColumnCount();this.colMenu.removeAll();for(var i=0;i<colCount;i++){if(cm.config[i].fixed!==true&&cm.config[i].hideable!==false){this.colMenu.add(new L5.menu.CheckItem({id:"col-"+cm.getColumnId(i),text:cm.getColumnHeader(i),checked:!cm.isHidden(i),hideOnClick:false,disabled:cm.config[i].hideable===false}));}}},handleHdDown:function(e,t){if(L5.fly(t).hasClass('l-grid3-hd-btn')){e.stopEvent();var hd=this.findHeaderCell(t);L5.fly(hd).addClass('l-grid3-hd-menu-open');var index=this.getCellIndex(hd);this.hdCtxIndex=index;var ms=this.hmenu.items,cm=this.cm;ms.get("asc").setDisabled(!cm.isSortable(index));ms.get("desc").setDisabled(!cm.isSortable(index));this.hmenu.on("hide",function(){L5.fly(hd).removeClass('l-grid3-hd-menu-open');},this,{single:true});this.hmenu.show(t,"tl-bl?");}},handleHdOver:function(e,t){var hd=this.findHeaderCell(t);if(hd&&!this.headersDisabled){this.activeHd=hd;this.activeHdIndex=this.getCellIndex(hd);var fly=this.fly(hd);this.activeHdRegion=fly.getRegion();if(!this.cm.isMenuDisabled(this.activeHdIndex)){fly.addClass("l-grid3-hd-over");this.activeHdBtn=fly.child('.l-grid3-hd-btn');if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(hd.firstChild.offsetHeight-1)+'px';}}}},handleHdMove:function(e,t){if(this.activeHd&&!this.headersDisabled){var hw=this.splitHandleWidth||5;var r=this.activeHdRegion;var x=e.getPageX();var ss=this.activeHd.style;if(x-r.left<=hw&&this.cm.isResizable(this.activeHdIndex-1)){ss.cursor=L5.isAir?'move':L5.isSafari?'e-resize':'col-resize';}else if(r.right-x<=(!this.activeHdBtn?hw:2)&&this.cm.isResizable(this.activeHdIndex)){ss.cursor=L5.isAir?'move':L5.isSafari?'w-resize':'col-resize';}else{ss.cursor='';}}},handleHdOut:function(e,t){var hd=this.findHeaderCell(t);if(hd&&(!L5.isIE||!e.within(hd,true))){this.activeHd=null;this.fly(hd).removeClass("l-grid3-hd-over");hd.style.cursor='';}},hasRows:function(){var fc=this.mainBody.dom.firstChild;return fc&&fc.className!='l-grid-empty';},bind:function(d,c){this.initData(d,c);}});L5.grid.GridView.SplitDragZone=function(grid,hd){this.grid=grid;this.view=grid.getView();this.marker=this.view.resizeMarker;this.proxy=this.view.resizeProxy;L5.grid.GridView.SplitDragZone.superclass.constructor.call(this,hd,"gridSplitters"+this.grid.getGridEl().id,{dragElId:L5.id(this.proxy.dom),resizeFrame:false});this.scroll=false;this.hw=this.view.splitHandleWidth||5;};L5.extend(L5.grid.GridView.SplitDragZone,L5.dd.DDProxy,{b4StartDrag:function(x,y){this.view.headersDisabled=true;var h=this.view.mainWrap.getHeight();this.marker.setHeight(h);this.marker.show();this.marker.alignTo(this.view.getHeaderCell(this.cellIndex),'tl-tl',[-2,0]);this.proxy.setHeight(h);var w=this.cm.getColumnWidth(this.cellIndex);var minw=Math.max(w-this.grid.minColumnWidth,0);this.resetConstraints();this.setXConstraint(minw,1000);this.setYConstraint(0,0);this.minX=x-minw;this.maxX=x+1000;this.startPos=x;L5.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},handleMouseDown:function(e){var t=this.view.findHeaderCell(e.getTarget());if(t){var xy=this.view.fly(t).getXY(),x=xy[0],y=xy[1];var exy=e.getXY(),ex=exy[0],ey=exy[1];var w=t.offsetWidth,adjust=false;if((ex-x)<=this.hw){adjust=-1;}else if((x+w)-ex<=this.hw){adjust=0;}
if(adjust!==false){this.cm=this.grid.colModel;var ci=this.view.getCellIndex(t);if(adjust==-1){if(ci+adjust<0){return;}
while(this.cm.isHidden(ci+adjust)){--adjust;if(ci+adjust<0){return;}}}
this.cellIndex=ci+adjust;this.split=t.dom;if(this.cm.isResizable(this.cellIndex)&&!this.cm.isFixed(this.cellIndex)){L5.grid.GridView.SplitDragZone.superclass.handleMouseDown.apply(this,arguments);}}else if(this.view.columnDrag){this.view.columnDrag.callHandleMouseDown(e);}}},endDrag:function(e){this.marker.hide();var v=this.view;var endX=Math.max(this.minX,e.getPageX());var diff=endX-this.startPos;v.onColumnSplitterMoved(this.cellIndex,this.cm.getColumnWidth(this.cellIndex)+diff);setTimeout(function(){v.headersDisabled=false;},50);},autoOffset:function(){this.setDelta(0,0);}});

L5.grid.ScollGridView=L5.extend(L5.grid.GridView,{rangPX:0,rowSize:0,lastScrollPos:0,initTemplates:function(){var ts=this.templates||{};if(!ts.master){ts.master=new L5.Template('<div class="l-grid3" hidefocus="true">','<div class="l-grid3-viewport">','<div class="l-grid3-header"><div class="l-grid3-header-inner"><div class="l-grid3-header-offset">{header}</div></div><div class="l-clear"></div></div>','<div class="l-grid3-scroller" style="auto:scroll;position:absolute;"><div></div><a href="#" class="l-grid3-focus" tabIndex="-1"></a></div>','<div style="overflow:hidden;position:absolute;" class="l-grid3-body" >{body}</div>',this.renderSum?'{sum}':'','</div>','<div class="l-grid3-resize-marker">&#160;</div>','<div class="l-grid3-resize-proxy">&#160;</div>',"</div>");}
if(!ts.body){ts.body=new L5.Template('<div class="l-grid3-header-offset">{rows}</div>');}
this.templates=ts;L5.grid.ScollGridView.superclass.initTemplates.apply(this,arguments);},initElements:function(){L5.grid.ScollGridView.superclass.initElements.apply(this,arguments);var E=L5.Element;if(this.renderSum){this.mainSum=new E(this.mainWrap.dom.childNodes[3]);this.sumBody=new E(this.mainSum.dom.firstChild.firstChild.rows[0]);}
this.mainBody=new E(this.mainWrap.dom.childNodes[2]);this.focusEl=new E(this.scroller.dom.childNodes[0]);this.focusEl.swallowEvent("click",true);},getRows:function(){return this.hasRows()?this.mainBody.child('div:first-child').dom.childNodes:[];},removeRows:function(firstRow,lastRow){var bd=this.mainBody.child('div:first-child').dom;for(var rowIndex=firstRow;rowIndex<=lastRow;rowIndex++){L5.removeNode(bd.childNodes[firstRow]);}
this.syncFocusEl(firstRow);},syncScroll:function(e){this.syncHeaderScroll();this.syncRowsScroll();var mb=this.scroller.dom;this.grid.fireEvent("bodyscroll",mb.scrollLeft,mb.scrollTop);},syncRowsScroll:function(){var scrtop=this.scroller.dom.scrollTop;var startpos=Math.ceil(scrtop/this.rangPX);if(startpos+this.rowSize==this.ds.getCount())
startpos+=1;this.mainBody.child('div:first-child').dom.innerHTML=this.renderRows(startpos,startpos+this.rowSize-1);this.lastScrollPos=startpos;this.processRows(startpos,true);},processRows:function(startRow,skipStripe){if(this.ds.getCount()<1){return;}
skipStripe=skipStripe||!this.grid.stripeRows;startRow=startRow||0;var rows=this.getRows();var cls=' l-grid3-row-alt ';if(this.grid.isEditor||this.grid.notSelectFirstRow){rows[0].className+=' l-grid3-row-first ';}else{this.grid.getSelectionModel().selectFirstRow();rows[0].className+=' l-grid3-row-first l-grid3-row-selected';}
rows[rows.length-1].className+=' l-grid3-row-last';for(var i=0;i<rows.length;i++){var row=rows[i];row.rowIndex=startRow+i;var numbererCell=L5.fly(row).query("div.l-grid3-col-numberer",row);if(numbererCell[0]){numbererCell[0].innerHTML=startRow+i+1;}
if(!skipStripe){var isAlt=((startRow+i+1)%2==0);var hasAlt=(' '+row.className+' ').indexOf(cls)!=-1;if(isAlt==hasAlt){continue;}
if(isAlt){row.className+=" l-grid3-row-alt";}else{row.className=row.className.replace("l-grid3-row-alt","");}}}},syncHeaderScroll:function(){var mb=this.scroller.dom;this.mainBody.dom.scrollLeft=mb.scrollLeft;this.mainBody.dom.scrollLeft=mb.scrollLeft;this.innerHd.scrollLeft=mb.scrollLeft;this.innerHd.scrollLeft=mb.scrollLeft;},doRenderOneRow:function(){var colCount=this.cm.getColumnCount();var ts=this.templates,ct=ts.cell,rt=ts.row,last=colCount-1;var tstyle='width:'+this.getTotalWidth()+';';var buf=[],c,p={},rp={tstyle:tstyle},cb=[];var cs=this.getColumnData();for(var i=0;i<colCount;i++){c=cs[i];p.id=c.id;p.css=i==0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':'');p.attr=p.cellAttr="";p.value="";p.style=c.style;if(p.value==undefined||p.value==="")p.value="&#160;";cb[cb.length]=ct.apply(p);}
var alt=[];rp.cols=colCount;rp.alt=alt.join(" ");rp.cells=cb.join("");buf[buf.length]=rt.apply(rp);return buf.join("");},afterRender:function(){this.mainBody.child('div:first-child').dom.innerHTML=this.doRenderOneRow();this.rangPX=this.mainBody.child('div:first-child').child('div:first-child').getHeight();this.rowSize=Math.ceil(this.mainBody.getHeight()/this.rangPX);this.scroller.child('div:first-child').setHeight(this.grid.dataset.getCount()*this.rangPX);var rangPY=this.mainBody.child('div:first-child').child('div:first-child').getWidth();this.scroller.child('div:first-child').setWidth(rangPY);this.mainBody.child('div:first-child').dom.innerHTML=this.renderRows(0,this.rowSize-1);this.lastScrollPos=0;this.processRows(0,true);if(this.deferEmptyText!==true){this.applyEmptyText();}},renderUI:function(){var header=this.renderHeaders();var body=this.templates.body.apply({rows:''});var html=this.templates.master.apply({body:body,header:header});var g=this.grid;g.getGridEl().dom.innerHTML=html;this.initElements();L5.fly(this.innerHd).on("click",this.handleHdDown,this);this.mainHd.on("mouseover",this.handleHdOver,this);this.mainHd.on("mouseout",this.handleHdOut,this);this.mainHd.on("mousemove",this.handleHdMove,this);this.scroller.on('scroll',this.syncScroll,this);this.mainBody.on('mousewheel',this.handleWheel,this);if(g.enableColumnResize!==false){this.splitZone=new L5.grid.GridView.SplitDragZone(g,this.mainHd.dom);}
if(g.enableColumnMove){this.columnDrag=new L5.grid.GridView.ColumnDragZone(g,this.innerHd);this.columnDrop=new L5.grid.HeaderDropZone(g,this.mainHd.dom);}
if(g.trackMouseOver){this.mainBody.on("mouseover",this.onRowOver,this);this.mainBody.on("mouseout",this.onRowOut,this);}
if(g.enableDragDrop||g.enableDrag){this.dragZone=new L5.grid.GridDragZone(g,{ddGroup:g.ddGroup||'GridDD'});}
this.updateHeaderSortState();},onLayout:function(vw,vh){this.mainBody.setHeight(this.scroller.getHeight()-this.scrollOffset+5);this.mainBody.setWidth(this.scroller.getWidth()-this.scrollOffset);this.afterRender()},renderBody:function(){var markup=this.renderRows(0,this.rowSize-1);return this.templates.body.apply({rows:markup});},applyEmptyText:function(){if(this.emptyText&&!this.hasRows()){this.mainBody.child('div:first-child').update('<div class="l-grid-empty">'+this.emptyText+'</div>');}},onColumnMove:function(cm,oldIndex,newIndex){this.indexMap=null;var s=this.getScrollState();this.refresh(true);this.restoreScroll(s);this.afterMove(newIndex);},handleWheel:function(e){var delta=e.getWheelDelta()*this.rangPX;if(this.scrollTimeout)
clearTimeout(this.scrollTimeout);var scrtop=this.scroller.dom.scrollTop;scrtop-=delta;this.scroller.dom.scrollTop=scrtop;e.stopPropagation();},getRow:function(row){return this.getRows()[row-this.lastScrollPos];},hasRows:function(){var fc=this.mainBody.child('div:first-child').dom.firstChild;return fc&&fc.className!='l-grid-empty';},ensureVisible:function(row,col,hscroll){var resolved=this.resolveCell(row,col,hscroll);if(!resolved||!resolved.row){return;}
var rowEl=resolved.row,cellEl=resolved.cell;var c=this.scroller.dom;var ctop=0;var p=rowEl,stop=this.el.dom;while(p&&p!=stop){ctop+=p.offsetTop;p=p.offsetParent;}
ctop-=this.mainHd.dom.offsetHeight;var stop=parseInt(c.scrollTop,10);var now=stop+ctop;var should=this.rangPX*row;if(hscroll!==false){var cleft=parseInt(cellEl.offsetLeft,10);var cright=cleft+cellEl.offsetWidth;var sleft=parseInt(c.scrollLeft,10);var sright=sleft+c.clientWidth;if(cleft<sleft){c.scrollLeft=cleft;}else if(cright>sright){c.scrollLeft=cright-c.clientWidth;}}
return this.getResolvedXY(resolved);}});

L5.grid.HeaderDragZone=function(grid,hd,hd2){this.grid=grid;this.view=grid.getView();this.ddGroup="gridHeader"+this.grid.getGridEl().id;L5.grid.HeaderDragZone.superclass.constructor.call(this,hd);if(hd2){this.setHandleElId(L5.id(hd));this.setOuterHandleElId(L5.id(hd2));}
this.scroll=false;};L5.extend(L5.grid.HeaderDragZone,L5.dd.DragZone,{maxDragWidth:120,getDragData:function(e){var t=L5.lib.Event.getTarget(e);var h=this.view.findHeaderCell(t);if(h){return{ddel:h.firstChild,header:h};}
return false;},onInitDrag:function(e){this.view.headersDisabled=true;var clone=this.dragData.ddel.cloneNode(true);clone.id=L5.id();clone.style.width=Math.min(this.dragData.header.offsetWidth,this.maxDragWidth)+"px";this.proxy.update(clone);return true;},afterValidDrop:function(){var v=this.view;setTimeout(function(){v.headersDisabled=false;},50);},afterInvalidDrop:function(){var v=this.view;setTimeout(function(){v.headersDisabled=false;},50);}});L5.grid.HeaderDropZone=function(grid,hd,hd2){this.grid=grid;this.view=grid.getView();this.proxyTop=L5.DomHelper.append(document.body,{cls:"col-move-top",html:"&#160;"},true);this.proxyBottom=L5.DomHelper.append(document.body,{cls:"col-move-bottom",html:"&#160;"},true);this.proxyTop.hide=this.proxyBottom.hide=function(){this.setLeftTop(-100,-100);this.setStyle("visibility","hidden");};this.ddGroup="gridHeader"+this.grid.getGridEl().id;L5.grid.HeaderDropZone.superclass.constructor.call(this,grid.getGridEl().dom);};L5.extend(L5.grid.HeaderDropZone,L5.dd.DropZone,{proxyOffsets:[-4,-9],fly:L5.Element.fly,getTargetFromEvent:function(e){var t=L5.lib.Event.getTarget(e);var cindex=this.view.findCellIndex(t);if(cindex!==false){return this.view.getHeaderCell(cindex);}},nextVisible:function(h){var v=this.view,cm=this.grid.colModel;h=h.nextSibling;while(h){if(!cm.isHidden(v.getCellIndex(h))){return h;}
h=h.nextSibling;}
return null;},prevVisible:function(h){var v=this.view,cm=this.grid.colModel;h=h.prevSibling;while(h){if(!cm.isHidden(v.getCellIndex(h))){return h;}
h=h.prevSibling;}
return null;},positionIndicator:function(h,n,e){var x=L5.lib.Event.getPageX(e);var r=L5.lib.Dom.getRegion(n.firstChild);var px,pt,py=r.top+this.proxyOffsets[1];if((r.right-x)<=(r.right-r.left)/2){px=r.right+this.view.borderWidth;pt="after";}else{px=r.left;pt="before";}
var oldIndex=this.view.getCellIndex(h);var newIndex=this.view.getCellIndex(n);if(this.grid.colModel.isFixed(newIndex)){return false;}
var locked=this.grid.colModel.isLocked(newIndex);if(pt=="after"){newIndex++;}
if(oldIndex<newIndex){newIndex--;}
if(oldIndex==newIndex&&(locked==this.grid.colModel.isLocked(oldIndex))){return false;}
px+=this.proxyOffsets[0];this.proxyTop.setLeftTop(px,py);this.proxyTop.show();if(!this.bottomOffset){this.bottomOffset=this.view.mainHd.getHeight();}
this.proxyBottom.setLeftTop(px,py+this.proxyTop.dom.offsetHeight+this.bottomOffset);this.proxyBottom.show();return pt;},onNodeEnter:function(n,dd,e,data){if(data.header!=n){this.positionIndicator(data.header,n,e);}},onNodeOver:function(n,dd,e,data){var result=false;if(data.header!=n){result=this.positionIndicator(data.header,n,e);}
if(!result){this.proxyTop.hide();this.proxyBottom.hide();}
return result?this.dropAllowed:this.dropNotAllowed;},onNodeOut:function(n,dd,e,data){this.proxyTop.hide();this.proxyBottom.hide();},onNodeDrop:function(n,dd,e,data){var h=data.header;if(h!=n){var cm=this.grid.colModel;var x=L5.lib.Event.getPageX(e);var r=L5.lib.Dom.getRegion(n.firstChild);var pt=(r.right-x)<=((r.right-r.left)/2)?"after":"before";var oldIndex=this.view.getCellIndex(h);var newIndex=this.view.getCellIndex(n);var locked=cm.isLocked(newIndex);if(pt=="after"){newIndex++;}
if(oldIndex<newIndex){newIndex--;}
if(oldIndex==newIndex&&(locked==cm.isLocked(oldIndex))){return false;}
cm.setLocked(oldIndex,locked,true);cm.moveColumn(oldIndex,newIndex);this.grid.fireEvent("columnmove",oldIndex,newIndex);return true;}
return false;}});L5.grid.GridView.ColumnDragZone=function(grid,hd){L5.grid.GridView.ColumnDragZone.superclass.constructor.call(this,grid,hd,null);this.proxy.el.addClass('l-grid3-col-dd');};L5.extend(L5.grid.GridView.ColumnDragZone,L5.grid.HeaderDragZone,{handleMouseDown:function(e){},callHandleMouseDown:function(e){L5.grid.GridView.ColumnDragZone.superclass.handleMouseDown.call(this,e);}});

L5.grid.SplitDragZone=function(grid,hd,hd2){this.grid=grid;this.view=grid.getView();this.proxy=this.view.resizeProxy;L5.grid.SplitDragZone.superclass.constructor.call(this,hd,"gridSplitters"+this.grid.getGridEl().id,{dragElId:L5.id(this.proxy.dom),resizeFrame:false});this.setHandleElId(L5.id(hd));this.setOuterHandleElId(L5.id(hd2));this.scroll=false;};L5.extend(L5.grid.SplitDragZone,L5.dd.DDProxy,{fly:L5.Element.fly,b4StartDrag:function(x,y){this.view.headersDisabled=true;this.proxy.setHeight(this.view.mainWrap.getHeight());var w=this.cm.getColumnWidth(this.cellIndex);var minw=Math.max(w-this.grid.minColumnWidth,0);this.resetConstraints();this.setXConstraint(minw,1000);this.setYConstraint(0,0);this.minX=x-minw;this.maxX=x+1000;this.startPos=x;L5.dd.DDProxy.prototype.b4StartDrag.call(this,x,y);},handleMouseDown:function(e){ev=L5.EventObject.setEvent(e);var t=this.fly(ev.getTarget());if(t.hasClass("l-grid-split")){this.cellIndex=this.view.getCellIndex(t.dom);this.split=t.dom;this.cm=this.grid.colModel;if(this.cm.isResizable(this.cellIndex)&&!this.cm.isFixed(this.cellIndex)){L5.grid.SplitDragZone.superclass.handleMouseDown.apply(this,arguments);}}},endDrag:function(e){this.view.headersDisabled=false;var endX=Math.max(this.minX,L5.lib.Event.getPageX(e));var diff=endX-this.startPos;this.view.onColumnSplitterMoved(this.cellIndex,this.cm.getColumnWidth(this.cellIndex)+diff);},autoOffset:function(){this.setDelta(0,0);}});

L5.grid.GridDragZone=function(grid,config){this.view=grid.getView();L5.grid.GridDragZone.superclass.constructor.call(this,this.view.mainBody.dom,config);if(this.view.lockedBody){this.setHandleElId(L5.id(this.view.mainBody.dom));this.setOuterHandleElId(L5.id(this.view.lockedBody.dom));}
this.scroll=false;this.grid=grid;this.ddel=document.createElement('div');this.ddel.className='l-grid-dd-wrap';};L5.extend(L5.grid.GridDragZone,L5.dd.DragZone,{ddGroup:"GridDD",getDragData:function(e){var t=L5.lib.Event.getTarget(e);var rowIndex=this.view.findRowIndex(t);if(rowIndex!==false){var sm=this.grid.selModel;if(!sm.isSelected(rowIndex)||e.hasModifier()){sm.handleMouseDown(this.grid,rowIndex,e);}
return{grid:this.grid,ddel:this.ddel,rowIndex:rowIndex,selections:sm.getSelections()};}
return false;},onInitDrag:function(e){var data=this.dragData;this.ddel.innerHTML=this.grid.getDragDropText();this.proxy.update(this.ddel);},afterRepair:function(){this.dragging=false;},getRepairXY:function(e,data){return false;},onEndDrag:function(data,e){},onValidDrop:function(dd,e,id){this.hideProxy();},beforeInvalidDrop:function(e,id){}});

L5.grid.ColumnModel=function(config,grid){this.fileColumn=null;this.grid=grid;this.defaultWidth=100;this.defaultSortable=false;if(config.columns){L5.apply(this,config);this.setConfig(config.columns,true);}else{this.setConfig(config,true);}
this.addEvents("widthchange","headerchange","hiddenchange","columnmoved","columnlockchange","configchange");L5.grid.ColumnModel.superclass.constructor.call(this);};L5.extend(L5.grid.ColumnModel,L5.util.Observable,{getColumnId:function(index){return this.config[index].id;},turnWidthHeight:function(value,wh){if(value&&!L5.num(value)){if(value.indexOf("%")>0){var tempWidth=value.substring(0,(value.indexOf("%")))/100;var temp=(wh=="w")?L5.getBody().getWidth()-45:L5.getBody().getHeight();return tempWidth*temp;}else{return value;}}else{return value;}},setConfig:function(config,initial){if(!initial){delete this.totalWidth;for(var i=0,len=this.config.length;i<len;i++){var c=this.config[i];if(c.width){this.config[i].width=c.width=this.turnWidthHeight(c.width,"w");}
if(c.height){this.config[i].height=c.height=this.turnWidthHeight(c.width,"h");}
if(c.editor){c.editor.destroy();}}}
this.config=config;this.lookup={};for(var i=0,len=config.length;i<len;i++){var c=config[i];if(c.width){this.config[i].width=c.width=this.turnWidthHeight(c.width,"w");}
if(c.height){this.config[i].height=c.height=this.turnWidthHeight(c.width,"h");}
if(c.isFileColumn){c.id='fileColumn';this.fileColumn=i;}
if(c.sortable){this.config[i].sortable=c.sortable;}
if(typeof c.renderer=="string"){c.renderer=L5.util.Format[c.renderer];}
if(typeof c.id=="undefined"){c.id=i;}
if(c.editor&&c.editor.isFormField){c.editor=new L5.grid.GridEditor(c.editor);}
this.lookup[c.id]=c;}
if(!initial){this.fireEvent('configchange',this);}},getColumnById:function(id){return this.lookup[id];},getIndexById:function(id){for(var i=0,len=this.config.length;i<len;i++){if(this.config[i].id==id){return i;}}
return-1;},moveColumn:function(oldIndex,newIndex){var c=this.config[oldIndex];this.config.splice(oldIndex,1);this.config.splice(newIndex,0,c);this.dataMap=null;this.fireEvent("columnmoved",this,oldIndex,newIndex);},isLocked:function(colIndex){return this.config[colIndex].locked===true;},setLocked:function(colIndex,value,suppressEvent){if(this.isLocked(colIndex)==value){return;}
this.config[colIndex].locked=value;if(!suppressEvent){this.fireEvent("columnlockchange",this,colIndex,value);}},getTotalLockedWidth:function(){var totalWidth=0;for(var i=0;i<this.config.length;i++){if(this.isLocked(i)&&!this.isHidden(i)){this.totalWidth+=this.getColumnWidth(i);}}
return totalWidth;},getLockedCount:function(){for(var i=0,len=this.config.length;i<len;i++){if(!this.isLocked(i)){return i;}}},getColumnCount:function(visibleOnly){if(visibleOnly===true){var c=0;for(var i=0,len=this.config.length;i<len;i++){if(!this.isHidden(i)){c++;}}
return c;}
return this.config.length;},getColumnsBy:function(fn,scope){var r=[];for(var i=0,len=this.config.length;i<len;i++){var c=this.config[i];if(fn.call(scope||this,c,i)===true){r[r.length]=c;}}
return r;},isSortable:function(col){if(typeof this.config[col].sortable=="undefined"){return this.defaultSortable;}
return this.config[col].sortable;},isMenuDisabled:function(col){return!!this.config[col].menuDisabled;},isFileColumn:function(col){return this.config[col].isFileColumn;},getRenderer:function(col){if(!this.config[col].renderer){if(this.isFileColumn(col)){return L5.grid.ColumnModel.fileRenderer;}else
return L5.grid.ColumnModel.defaultRenderer;}
return this.config[col].renderer;},setRenderer:function(col,fn){this.config[col].renderer=fn;},getColumnWidth:function(col){return this.config[col].width||this.defaultWidth;},setColumnWidth:function(col,width,suppressEvent){this.config[col].width=width;this.totalWidth=null;if(!suppressEvent){this.fireEvent("widthchange",this,col,width);}},getTotalWidth:function(includeHidden){if(!this.totalWidth){this.totalWidth=0;for(var i=0,len=this.config.length;i<len;i++){if(includeHidden||!this.isHidden(i)){this.totalWidth+=this.getColumnWidth(i);}}
var width=(this.totalWidth/1);if(isNaN(width)){this.totalWidth=this.grid.width;}}
return this.totalWidth;},getColumnHeader:function(col){return this.config[col].header;},setColumnHeader:function(col,header){this.config[col].header=header;this.fireEvent("headerchange",this,col,header);},getColumnTooltip:function(col){return this.config[col].tooltip;},setColumnTooltip:function(col,tooltip){this.config[col].tooltip=tooltip;},getDataIndex:function(col){return this.config[col].field;},setDataIndex:function(col,field){this.config[col].field=field;},findColumnIndex:function(field){var c=this.config;for(var i=0,len=c.length;i<len;i++){if(c[i].field==field){return i;}}
return-1;},isCellEditable:function(colIndex,rowIndex){if(L5.type(this.config[colIndex].editable)=='function')
return this.config[colIndex].editable(colIndex,rowIndex);return(this.config[colIndex].editable||(typeof this.config[colIndex].editable=="undefined"&&this.config[colIndex].editor))?true:false;},getCellEditor:function(colIndex,rowIndex){return this.config[colIndex].editor;},setEditable:function(col,editable){this.config[col].editable=editable;},isHidden:function(colIndex){return this.config[colIndex].hidden;},isFixed:function(colIndex){return this.config[colIndex].fixed;},setFixed:function(colIndex){return this.config[colIndex].fixed=true;},isResizable:function(colIndex){return colIndex>=0&&this.config[colIndex].resizable!==false&&this.config[colIndex].fixed!==true;},setHidden:function(colIndex,hidden){var c=this.config[colIndex];if(c.hidden!==hidden){c.hidden=hidden;this.totalWidth=null;this.fireEvent("hiddenchange",this,colIndex,hidden);}},setEditor:function(col,editor){this.config[col].editor=editor;}});L5.grid.ColumnModel.defaultRenderer=function(value){if(typeof value=="string"&&value.length<1){return"&#160;";}
if(value&&value.constructor==Date){return String(value);}
var htmlValue=/\<|\>/;if(L5.preventScriptInjection==true&&htmlValue.test(value)){return L5.util.Format.htmlEncode(value);}
return value;};L5.grid.ColumnModel.fileRenderer=function(file,p,record,rowIndex,colIndex,dataset,name){var filename=name+'['+rowIndex+']';if(record.state===L5.model.Record.STATE_NEW)
return"<input type='file' size='16' class='l-form-file' name='"+filename+"'/>";else{var modifyText=L5.columnModel_modifyTest?L5.columnModel_modifyTest:"Modify";var fName="";var table=null,column=null,pk=null;if(file.filename.indexOf(",")!=-1){var str=file.filename.split(",");table=str[0];column=str[1];pk=str[2];fName=str[3];}
dlUrl=L5.webPath+"/download?table="+table+"&column="+column+"&pk="+pk+"&pValue="+record.data[pk];return"<input type='button' dataset='"+dataset.id+"' class='l-form-file-button' onclick='L5.grid.ColumnModel.onEditClick(this)' name='"+filename+"' value='"+modifyText+"'/>"
+"<a href='"+dlUrl+"'>"+fName+"</a>";}};L5.grid.ColumnModel.onEditClick=function(b){var dataset=L5.DatasetMgr.lookup(b.getAttribute('dataset'));var filename=b.name;var fieldname=filename.substring(0,filename.indexOf('['));var index=filename.substring(filename.indexOf('[')+1,filename.indexOf('[')+2);var record=dataset.getAt(index);record.set(fieldname,filename);b.parentNode.innerHTML="<input type='file' size='16' class='l-form-file' name='"+b.name+"'/>";};L5.grid.DefaultColumnModel=L5.grid.ColumnModel;

L5.grid.AbstractSelectionModel=function(){this.locked=false;L5.grid.AbstractSelectionModel.superclass.constructor.call(this);};L5.extend(L5.grid.AbstractSelectionModel,L5.util.Observable,{init:function(grid){this.grid=grid;this.initEvents();},lock:function(){this.locked=true;},unlock:function(){this.locked=false;},isLocked:function(){return this.locked;}});

L5.grid.RowSelectionModel=function(config){L5.apply(this,config);this.selections=new L5.util.MixedCollection(false,function(o){return o.id;});this.last=false;this.lastActive=false;this.addEvents("selectionchange","beforerowselect","rowselect","rowdeselect");L5.grid.RowSelectionModel.superclass.constructor.call(this);};L5.extend(L5.grid.RowSelectionModel,L5.grid.AbstractSelectionModel,{singleSelect:false,initEvents:function(){if(!this.grid.enableDragDrop&&!this.grid.enableDrag){this.grid.on("rowmousedown",this.handleMouseDown,this);}else{this.grid.on("rowclick",function(grid,rowIndex,e){if(e.button===0&&!e.shiftKey&&!e.ctrlKey){this.selectRow(rowIndex,false);}},this);}
this.rowNav=new L5.KeyNav(this.grid.getGridEl(),{"up":function(e){if(!e.shiftKey||this.singleSelect){this.selectPrevious(false);}else if(this.last!==false&&this.lastActive!==false){var last=this.last;this.selectRange(this.last,this.lastActive-1);if(last!==false){this.last=last;}}else{this.selectFirstRow();}},"down":function(e){if(!e.shiftKey||this.singleSelect){this.selectNext(false);}else if(this.last!==false&&this.lastActive!==false){var last=this.last;this.selectRange(this.last,this.lastActive+1);if(last!==false){this.last=last;}}else{this.selectFirstRow();}},scope:this});var view=this.grid.view;view.on("rowupdated",this.onRowUpdated,this);view.on("rowremoved",this.onRemove,this);this.grid.dataset.on("move",this.onSelectedChange,this);},onSelectedChange:function(ds,rowIndex){if(this.last===rowIndex)return;this.selectRow(rowIndex);},onRefresh:function(){var ds=this.grid.dataset,index;var s=this.getSelections();this.clearSelections(true);for(var i=0,len=s.length;i<len;i++){var r=s[i];if((index=ds.indexOfId(r.id))!=-1){this.selectRow(index,true);}}
if(s.length!=this.selections.getCount()){this.fireEvent("selectionchange",this);}},onRemove:function(v,index,r){if(this.selections.remove(r)!==false){this.fireEvent('selectionchange',this);}},onRowUpdated:function(v,index,r){if(this.isSelected(r)){v.onRowSelect(index);}},selectRecords:function(records,keepExisting){if(!keepExisting){this.clearSelections();}
var ds=this.grid.dataset;for(var i=0,len=records.length;i<len;i++){this.selectRow(ds.indexOf(records[i]),true);}},getCount:function(){return this.selections.length;},selectFirstRow:function(){this.selectRow(0);},selectLastRow:function(keepExisting){this.selectRow(this.grid.dataset.getCount()-1,keepExisting);},selectNext:function(keepExisting){if(this.hasNext()){this.selectRow(this.last+1,keepExisting);this.grid.getView().focusRow(this.last);return true;}
return false;},selectPrevious:function(keepExisting){if(this.hasPrevious()){this.selectRow(this.last-1,keepExisting);this.grid.getView().focusRow(this.last);return true;}
return false;},hasNext:function(){return this.last!==false&&(this.last+1)<this.grid.dataset.getCount();},hasPrevious:function(){return!!this.last;},getSelections:function(){return[].concat(this.selections.items);},getSelected:function(){return this.selections.itemAt(0);},each:function(fn,scope){var s=this.getSelections();for(var i=0,len=s.length;i<len;i++){if(fn.call(scope||this,s[i],i)===false){return false;}}
return true;},clearSelections:function(fast){if(this.isLocked())return;if(fast!==true){var ds=this.grid.dataset;var s=this.selections;s.each(function(r){this.deselectRow(ds.indexOfId(r.id));},this);s.clear();}else{this.selections.clear();}
this.last=false;},selectAll:function(){if(this.isLocked())return;this.selections.clear();for(var i=0,len=this.grid.dataset.getCount();i<len;i++){this.selectRow(i,true);}},hasSelection:function(){return this.selections.length>0;},isSelected:function(index){var r=typeof index=="number"?this.grid.dataset.getAt(index):index;return(r&&this.selections.key(r.id)?true:false);},isIdSelected:function(id){return(this.selections.key(id)?true:false);},handleMouseDown:function(g,rowIndex,e){if(e.button!==0||this.isLocked()){return;};var view=this.grid.getView();if(e.shiftKey&&!this.singleSelect&&this.last!==false){var last=this.last;this.selectRange(last,rowIndex,e.ctrlKey);this.last=last;}else{var isSelected=this.isSelected(rowIndex);if(e.ctrlKey&&isSelected){this.deselectRow(rowIndex);}else if(!isSelected||this.getCount()>1){this.selectRow(rowIndex,e.ctrlKey||e.shiftKey);}}},selectRows:function(rows,keepExisting){if(!keepExisting){this.clearSelections();}
for(var i=0,len=rows.length;i<len;i++){this.selectRow(rows[i],true);}},selectRange:function(startRow,endRow,keepExisting){if(this.isLocked())return;if(!keepExisting){this.clearSelections();}
if(startRow<=endRow){for(var i=startRow;i<=endRow;i++){this.selectRow(i,true);}}else{for(var i=startRow;i>=endRow;i--){this.selectRow(i,true);}}},deselectRange:function(startRow,endRow,preventViewNotify){if(this.isLocked())return;for(var i=startRow;i<=endRow;i++){this.deselectRow(i,preventViewNotify);}},selectRow:function(index,keepExisting,preventViewNotify){if(this.isLocked()||(index<0||index>=this.grid.dataset.getCount())||this.isSelected(index))return;var r=this.grid.dataset.getAt(index);if(r&&this.fireEvent("beforerowselect",this,index,keepExisting,r)!==false){if(!keepExisting||this.singleSelect){if(this.singleSelect){var radio=L5.fly(this.grid.getView().getRow(index)).child(".l-grid3-row-radio",true);if(radio&&!radio.checked)
radio.checked=true;}
this.clearSelections();}
this.selections.add(r);this.last=this.lastActive=index;if(!preventViewNotify){this.grid.getView().onRowSelect(index);}
this.fireEvent("rowselect",this,index,r);this.fireEvent("selectionchange",this);this.grid.dataset.moveTo(index);}},deselectRow:function(index,preventViewNotify){if(this.isLocked())return;if(this.last==index){this.last=false;}
if(this.lastActive==index){this.lastActive=false;}
var r=this.grid.dataset.getAt(index);if(r){this.selections.remove(r);if(!preventViewNotify){this.grid.getView().onRowDeselect(index);}
this.fireEvent("rowdeselect",this,index,r);this.fireEvent("selectionchange",this);}},restoreLast:function(){if(this._last){this.last=this._last;}},acceptsNav:function(row,col,cm){return!cm.isHidden(col)&&cm.isCellEditable(col,row);},onEditorKey:function(field,e){var k=e.getKey(),newCell,g=this.grid,ed=g.activeEditor;var shift=e.shiftKey;if(k==e.TAB){e.stopEvent();ed.completeEdit();if(shift){newCell=g.walkCells(ed.row,ed.col-1,-1,this.acceptsNav,this);}else{newCell=g.walkCells(ed.row,ed.col+1,1,this.acceptsNav,this);}}else if(k==e.ENTER){e.stopEvent();ed.completeEdit();if(this.moveEditorOnEnter!==false){if(shift){newCell=g.walkCells(ed.row-1,ed.col,-1,this.acceptsNav,this);}else{newCell=g.walkCells(ed.row+1,ed.col,1,this.acceptsNav,this);}}}else if(k==e.ESC){ed.cancelEdit();}
if(newCell){g.startEditing(newCell[0],newCell[1]);}}});

L5.grid.CellSelectionModel=function(config){L5.apply(this,config);this.selection=null;this.addEvents("beforecellselect","cellselect","selectionchange");L5.grid.CellSelectionModel.superclass.constructor.call(this);};L5.extend(L5.grid.CellSelectionModel,L5.grid.AbstractSelectionModel,{initEvents:function(){this.grid.on("cellmousedown",this.handleMouseDown,this);this.grid.getGridEl().on(L5.isIE||L5.isSafari3?"keydown":"keypress",this.handleKeyDown,this);var view=this.grid.view;view.on("refresh",this.onViewChange,this);view.on("rowupdated",this.onRowUpdated,this);view.on("beforerowremoved",this.clearSelections,this);view.on("beforerowsinserted",this.clearSelections,this);if(this.grid.isEditor){this.grid.on("beforeedit",this.beforeEdit,this);}
this.grid.dataset.on("move",this.onSelectedChange,this);},onSelectedChange:function(ds,rowIndex){if(this.selection){if(this.selection.cell[0]==rowIndex){return;}else{this.select(rowIndex,this.selection.cell[1]);}}else{this.select(rowIndex,0);}},beforeEdit:function(e){this.select(e.row,e.column,false,true,e.record);},onRowUpdated:function(v,index,r){if(this.selection&&this.selection.record==r){v.onCellSelect(index,this.selection.cell[1]);}},onViewChange:function(){this.clearSelections(true);},getSelectedCell:function(){return this.selection?this.selection.cell:null;},clearSelections:function(preventNotify){var s=this.selection;if(s){if(preventNotify!==true){this.grid.view.onCellDeselect(s.cell[0],s.cell[1]);}
this.selection=null;this.fireEvent("selectionchange",this,null);}},hasSelection:function(){return this.selection?true:false;},handleMouseDown:function(g,row,cell,e){if(e.button!==0||this.isLocked()){return;};this.select(row,cell);},select:function(rowIndex,colIndex,preventViewNotify,preventFocus,r){if(this.fireEvent("beforecellselect",this,rowIndex,colIndex)!==false){this.clearSelections();r=r||this.grid.dataset.getAt(rowIndex);this.selection={record:r,cell:[rowIndex,colIndex]};if(!preventViewNotify){var v=this.grid.getView();v.onCellSelect(rowIndex,colIndex);if(preventFocus!==true){}}
this.fireEvent("cellselect",this,rowIndex,colIndex);this.fireEvent("selectionchange",this,this.selection);this.grid.dataset.moveTo(rowIndex);}},isSelectable:function(rowIndex,colIndex,cm){return!cm.isHidden(colIndex);},handleKeyDown:function(e){if(!e.isNavKeyPress()){return;}
var g=this.grid,s=this.selection;if(!s){e.stopEvent();var cell=g.walkCells(0,0,1,this.isSelectable,this);if(cell){this.select(cell[0],cell[1]);}
return;}
var sm=this;var walk=function(row,col,step){return g.walkCells(row,col,step,sm.isSelectable,sm);};var k=e.getKey(),r=s.cell[0],c=s.cell[1];var newCell;switch(k){case e.TAB:if(e.shiftKey){newCell=walk(r,c-1,-1);}else{newCell=walk(r,c+1,1);}
break;case e.DOWN:newCell=walk(r+1,c,1);break;case e.UP:newCell=walk(r-1,c,-1);break;case e.RIGHT:newCell=walk(r,c+1,1);break;case e.LEFT:newCell=walk(r,c-1,-1);break;case e.ENTER:if(g.isEditor&&!g.editing){g.startEditing(r,c);e.stopEvent();return;}
break;};if(newCell){this.select(newCell[0],newCell[1]);e.stopEvent();}},acceptsNav:function(row,col,cm){return!cm.isHidden(col)&&cm.isCellEditable(col,row);},onEditorKey:function(field,e){var k=e.getKey(),newCell,g=this.grid,ed=g.activeEditor;if(k==e.TAB){if(e.shiftKey){newCell=g.walkCells(ed.row,ed.col-1,-1,this.acceptsNav,this);}else{newCell=g.walkCells(ed.row,ed.col+1,1,this.acceptsNav,this);}
e.stopEvent();}else if(k==e.ENTER){ed.completeEdit();e.stopEvent();}else if(k==e.ESC){e.stopEvent();ed.cancelEdit();}
if(newCell){g.startEditing(newCell[0],newCell[1]);}}});

L5.grid.EditorGridPanel=L5.extend(L5.grid.GridPanel,{clicksToEdit:1,isEditor:true,detectEdit:false,autoEncode:false,trackMouseOver:false,assistSave:L5.emptyFn,scrollFollowSkip:false,editorContextMenu:null,initComponent:function(){L5.grid.EditorGridPanel.superclass.initComponent.call(this);if(!this.selModel){this.selModel=new L5.grid.CellSelectionModel();}
this.activeEditor=null;this.addEvents("beforeedit","afteredit","validateedit");},initEvents:function(){L5.grid.EditorGridPanel.superclass.initEvents.call(this);this.on("bodyscroll",this.stopEditing,this,[true]);this.on("columnresize",this.stopEditing,this,[true]);if(!this.assistWin){if(this.clicksToEdit==1){this.on("cellclick",this.onCellDblClick,this);}else{if(this.clicksToEdit=='auto'&&this.view.mainBody){this.view.mainBody.on("mousedown",this.onAutoEditClick,this);}
this.on("celldblclick",this.onCellDblClick,this);}}},initShowWin:function(){L5.grid.EditorGridPanel.superclass.initShowWin.call(this);var grid=this;this.assistWindow.addTool({id:'savewin',align:'left',handler:function(event,toolEl,win){grid.stopEditing();win.hide();if(grid.assistSave){grid.assistSave.call(grid);}}});this.assistWindow.on("resize",this.stopEditing,this);this.assistWindow.on("move",this.stopEditing,this);},ShowWin:function(grid,rowIndex,e){L5.grid.EditorGridPanel.superclass.ShowWin.call(this,grid,rowIndex,e);var win=this.assistWindow;if(win){var celldetails=L5.DomQuery.select("*[@celldetail]",win.body.dom);for(var k=0,l=celldetails.length;k<l;k++){var ele=celldetails[k];var colrow=ele.getAttribute("celldetail");var params=colrow.split(",");params[params.length]=ele;params[params.length]=this.el.dom;if(ele.nodeName.toLowerCase()!="label"){L5.get(ele).on("click",this.startEditing.createDelegate(this,params));}
if(ele.getAttribute("render4win")){ele.setAttribute("renderer",this.renderEl4Win.createDelegate(this,params));}}
L5.bindingdata(win.body.dom);for(var k=0,l=celldetails.length;k<l;k++){var ele=celldetails[k];if(ele.getAttribute("render4win")){var colrow=ele.getAttribute("celldetail");var params=colrow.split(",");params[params.length]=ele;params[params.length]=this.el.dom;if(ele.nodeName.toLowerCase()!="label"){L5.get(ele.parentNode.firstChild).on("blur",this.startEditing.createDelegate(this,params));}
try{L5.fireEvent(ele,"blur");L5.fireEvent(ele,"change");}catch(e){}
ele.removeAttribute("render4win");}}}},createEl4Win:function(cfg,row,col){var editable=this.colModel.isCellEditable(col,row);if(cfg.editor&&editable){str='<input style="width:80%;height:20px;align:center;" celldetail="'
+row+','+col+'"  field="'
+cfg.field+'"'+(cfg.renderer?(' render4win="true"'):'')+'></input>';}else{str='<label  celldetail="'
+row+','+col+'"  field="'
+cfg.field+'"'+(cfg.renderer?(' render4win="true"'):'')+'></label>';}
return str;},renderEl4Win:function(row,col,ele,value){value=ele?ele.value:value;var rec=this.dataset.getAt(row);var cfg=this.colModel.config[col];var renderRes=cfg.renderer(value,null,rec,row,col,this.dataset,cfg.field,this);return renderRes;},onCellDblClick:function(g,row,col){this.startEditing(row,col);},onAutoEditClick:function(e,t){if(e.button!==0){return;}
var row=this.view.findRowIndex(t);var col=this.view.findCellIndex(t);if(row!==false&&col!==false){this.stopEditing();if(this.selModel.getSelectedCell){var sc=this.selModel.getSelectedCell();if(sc&&sc.cell[0]===row&&sc.cell[1]===col){this.startEditing(row,col);}}else{if(this.selModel.isSelected(row)){this.startEditing(row,col);}}}},onEditComplete:function(ed,value,startValue){this.editing=false;this.activeEditor=null;ed.un("specialkey",this.selModel.onEditorKey,this.selModel);var r=ed.record;var field=this.colModel.getDataIndex(ed.col);value=this.postEditValue(value,startValue,r,field);var changed=false;if(value&&startValue&&value.getTime&&startValue.getTime){changed=(value.getTime()!==startValue.getTime());}else{changed=(String(value)!==String(startValue));}
if(changed){var e={grid:this,record:r,field:field,originalValue:startValue,value:value,row:ed.row,column:ed.col,cancel:false};if(this.fireEvent("validateedit",e)!==false&&!e.cancel){r.set(field,e.value);delete e.cancel;this.fireEvent("afteredit",e);}}},startEditing:function(row,col,ele,parentDom){this.stopEditing();if(this.colModel.isCellEditable(col,row)){this.view.ensureVisible(row,col,true);var r=this.dataset.getAt(row);var field=this.colModel.getDataIndex(col);var e={grid:this,record:r,field:field,value:r.data[field],row:row,column:col,cancel:false};if(this.fireEvent("beforeedit",e)!==false&&!e.cancel){var ed=this.colModel.getCellEditor(col,row);if(typeof ed.field.editable=='function'){var result=ed.field.editable.call(this);if(!result)
return;}else if(!ed.field.editable)
return;this.editing=true;if(!ed.rendered){parentDom=parentDom?parentDom:this.view.getEditorParent(ed);ed.render(parentDom);}
(function(){ed.row=row;ed.col=col;ed.rowIndex=row;ed.cellIndex=col;ed.record=r;ed.on("complete",this.onEditComplete,this,{single:true});ed.on("specialkey",this.selModel.onEditorKey,this.selModel);this.activeEditor=ed;if(this.getEditorMenu()!=null){this.activeEditor.on("contextmenu",this.getEditorMenu(),this.activeEditor);}
var v=this.preEditValue(r,field);ele=ele?ele:this.view.getCell(row,col).firstChild;ed.startEdit(ele,v===undefined?'':v);}).defer(50,this);}}},preEditValue:function(r,field){var value=r.data[field];return this.autoEncode&&typeof value=='string'?L5.util.Format.htmlDecode(value):value;},postEditValue:function(value,originalValue,r,field){return this.autoEncode&&typeof value=='string'?L5.util.Format.htmlEncode(value):value;},stopEditing:function(cancel){if(this.activeEditor){this.activeEditor[cancel===true?'cancelEdit':'completeEdit']();}
this.activeEditor=null;},setEditorMenu:function(fun){if(fun!=null){this.editorContextMenu=fun;}},getEditorMenu:function(){return this.editorContextMenu;},onDestroy:function(){if(this.rendered){var cols=this.colModel.config;for(var i=0,len=cols.length;i<len;i++){var c=cols[i];L5.destroy(c.editor);}}
L5.grid.EditorGridPanel.superclass.onDestroy.call(this);}});L5.reg('editorgrid',L5.grid.EditorGridPanel);

L5.grid.GridEditor=function(field,config){L5.grid.GridEditor.superclass.constructor.call(this,field,config);field.monitorTab=false;};L5.extend(L5.grid.GridEditor,L5.Editor,{alignment:"tl-tl",autoSize:"width",hideEl:false,cls:"l-small-editor l-grid-editor",shim:false,shadow:false});

L5.grid.PropertyRecord=L5.model.Record.create([{name:'name',type:'string'},'value']);L5.grid.PropertyDataset=function(grid,source){this.grid=grid;this.dataset=new L5.model.Dataset({recordType:L5.grid.PropertyRecord});this.dataset.on('update',this.onUpdate,this);if(source){this.setSource(source);}
L5.grid.PropertyDataset.superclass.constructor.call(this);};L5.extend(L5.grid.PropertyDataset,L5.util.Observable,{setSource:function(o){this.source=o;this.dataset.removeAll();var data=[];for(var k in o){if(this.isEditableValue(o[k])){data.push(new L5.grid.PropertyRecord({name:k,value:o[k]},k));}}
this.dataset.loadRecords({records:data},{},true);},onUpdate:function(ds,record,type){if(type==L5.model.Record.EDIT){var v=record.data['value'];var oldValue=record.modified['value'];if(this.grid.fireEvent('beforepropertychange',this.source,record.id,v,oldValue)!==false){this.source[record.id]=v;record.commit();this.grid.fireEvent('propertychange',this.source,record.id,v,oldValue);}else{record.reject();}}},getProperty:function(row){return this.dataset.getAt(row);},isEditableValue:function(val){if(L5.isDate(val)){return true;}else if(typeof val=='object'||typeof val=='function'){return false;}
return true;},setValue:function(prop,value){this.source[prop]=value;this.dataset.getById(prop).set('value',value);},getSource:function(){return this.source;}});L5.grid.PropertyColumnModel=function(grid,dataset){this.grid=grid;var g=L5.grid;g.PropertyColumnModel.superclass.constructor.call(this,[{header:this.nameText,width:50,sortable:true,field:'name',id:'name',menuDisabled:true},{header:this.valueText,width:50,resizable:false,field:'value',id:'value',menuDisabled:true}]);this.dataset=dataset;this.bselect=L5.DomHelper.append(document.body,{tag:'select',cls:'l-grid-editor l-hide-display',children:[{tag:'option',value:'true',html:'true'},{tag:'option',value:'false',html:'false'}]});var f=L5.form;var bfield=new f.Field({el:this.bselect,bselect:this.bselect,autoShow:true,getValue:function(){return this.bselect.value=='true';}});this.editors={'date':new g.GridEditor(new f.DateField({selectOnFocus:true})),'string':new g.GridEditor(new f.TextField({selectOnFocus:true})),'number':new g.GridEditor(new f.NumberField({selectOnFocus:true,style:'text-align:left;'})),'boolean':new g.GridEditor(bfield)};this.renderCellDelegate=this.renderCell.createDelegate(this);this.renderPropDelegate=this.renderProp.createDelegate(this);};L5.extend(L5.grid.PropertyColumnModel,L5.grid.ColumnModel,{nameText:'Name',valueText:'Value',dateFormat:'m/j/Y',renderDate:function(dateVal){return dateVal.dateFormat(this.dateFormat);},renderBool:function(bVal){return bVal?'true':'false';},isCellEditable:function(colIndex,rowIndex){return colIndex==1;},getRenderer:function(col){return col==1?this.renderCellDelegate:this.renderPropDelegate;},renderProp:function(v){return this.getPropertyName(v);},renderCell:function(val){var rv=val;if(L5.isDate(val)){rv=this.renderDate(val);}else if(typeof val=='boolean'){rv=this.renderBool(val);}
return L5.util.Format.htmlEncode(rv);},getPropertyName:function(name){var pn=this.grid.propertyNames;return pn&&pn[name]?pn[name]:name;},getCellEditor:function(colIndex,rowIndex){var p=this.dataset.getProperty(rowIndex);var n=p.data['name'],val=p.data['value'];if(this.grid.customEditors[n]){return this.grid.customEditors[n];}
if(L5.isDate(val)){return this.editors['date'];}else if(typeof val=='number'){return this.editors['number'];}else if(typeof val=='boolean'){return this.editors['boolean'];}else{return this.editors['string'];}}});L5.grid.PropertyGrid=L5.extend(L5.grid.EditorGridPanel,{enableColumnMove:false,stripeRows:false,trackMouseOver:false,clicksToEdit:1,enableHdMenu:false,viewConfig:{forceFit:true},initComponent:function(){this.customEditors=this.customEditors||{};this.lastEditRow=null;var dataset=new L5.grid.PropertyDataset(this);this.propDataset=dataset;var cm=new L5.grid.PropertyColumnModel(this,dataset);dataset.dataset.sort('name','ASC');this.addEvents('beforepropertychange','propertychange');this.cm=cm;this.ds=dataset.dataset;L5.grid.PropertyGrid.superclass.initComponent.call(this);this.selModel.on('beforecellselect',function(sm,rowIndex,colIndex){if(colIndex===0){this.startEditing.defer(200,this,[rowIndex,1]);return false;}},this);},onRender:function(){L5.grid.PropertyGrid.superclass.onRender.apply(this,arguments);this.getGridEl().addClass('l-props-grid');},afterRender:function(){L5.grid.PropertyGrid.superclass.afterRender.apply(this,arguments);if(this.source){this.setSource(this.source);}},setSource:function(source){this.propDataset.setSource(source);},getSource:function(){return this.propDataset.getSource();}});L5.reg("propertygrid",L5.grid.PropertyGrid);

L5.grid.RowNumberer=function(config){L5.apply(this,config);if(this.rowspan){this.renderer=this.renderer.createDelegate(this);}};L5.grid.RowNumberer.prototype={header:"",width:23,sortable:false,locked:true,fixed:true,menuDisabled:true,field:'',id:'numberer',rowspan:undefined,renderer:function(v,p,record,rowIndex){if(this.rowspan){p.cellAttr='rowspan="'+this.rowspan+'"';}
return rowIndex+1;}};

L5.grid.CheckboxSelectionModel=L5.extend(L5.grid.RowSelectionModel,{header:'<div class="l-grid3-hd-checker"></div>',width:20,sortable:false,menuDisabled:true,fixed:true,field:'',id:'checker',initEvents:function(){if(!this.grid.enableDragDrop&&!this.grid.enableDrag){this.grid.on("rowmousedown",this.handleMouseDown,this);}else{this.grid.on("rowclick",function(grid,rowIndex,e){if(e.button===0&&!e.shiftKey&&!e.ctrlKey){this.selectRow(rowIndex,false);}},this);}
this.rowNav=new L5.KeyNav(this.grid.getGridEl(),{"up":function(e){if(!e.shiftKey||this.singleSelect){this.selectPrevious(false);}else if(this.last!==false&&this.lastActive!==false){var last=this.last;this.selectRange(this.last,this.lastActive-1);if(last!==false){this.last=last;}}else{this.selectFirstRow();}},"down":function(e){if(!e.shiftKey||this.singleSelect){this.selectNext(false);}else if(this.last!==false&&this.lastActive!==false){var last=this.last;this.selectRange(this.last,this.lastActive+1);if(last!==false){this.last=last;}}else{this.selectFirstRow();}},scope:this});var view=this.grid.view;view.on("rowupdated",this.onRowUpdated,this);view.on("rowremoved",this.onRemove,this);if((this.grid.clickToSelectedForChkSM==true)||(this.grid.clickToSelectedForChkSM==undefined&&L5.clickToSelectedForChkSM==true)){this.grid.dataset.on("move",this.onSelectedChange,this);}
this.grid.on('render',function(){var view=this.grid.getView();var dataset=this.grid.getDataset();dataset.on("turnPage",this.onTurnPage,this);view.mainBody.on('mousedown',this.onMouseDown,this);L5.fly(view.innerHd).on('mousedown',this.onHdMouseDown,this);},this);},handleMouseDown:function(g,rowIndex,e){if(e.button!==0||this.isLocked()){return;};var view=this.grid.getView();if(e.shiftKey&&!this.singleSelect&&this.last!==false){var last=this.last;this.selectRange(last,rowIndex,e.ctrlKey);this.last=last;}else{var isSelected=this.isSelected(rowIndex);if(e.ctrlKey&&isSelected){this.deselectRow(rowIndex);}else if(!isSelected||this.getCount()>1){if((this.grid.clickToSelectedForChkSM==true)||(this.grid.clickToSelectedForChkSM==undefined&&L5.clickToSelectedForChkSM==true)){this.selectRow(rowIndex,e.ctrlKey||e.shiftKey);}else{if(e.ctrlKey||e.shiftKey){this.selectRow(rowIndex,true);}else{view.toggleRowClass(rowIndex,"l-grid3-row-selected2");}}}}},onTurnPage:function(){var t=L5.fly(this.grid.getView().innerHd).child('.l-grid3-hd-checker-on');if(t){t.removeClass('l-grid3-hd-checker-on');this.clearSelections();}},onMouseDown:function(e,t){if(e.button===0&&t.className=='l-grid3-row-checker'){e.stopEvent();var row=e.getTarget('.l-grid3-row');if(row){var index=row.rowIndex;var view=this.grid.view;view.removeRowClass(view.lastToggleRow,"l-grid3-row-selected2")
if(this.isSelected(index)){this.deselectRow(index);var t=L5.fly(this.grid.getView().innerHd).child('.l-grid3-hd-checker-on');if(t){t.removeClass('l-grid3-hd-checker-on');}}else{this.selectRow(index,true);}}}},onHdMouseDown:function(e,t){if(t.className=='l-grid3-hd-checker'){e.stopEvent();var hd=L5.fly(t.parentNode);var isChecked=hd.hasClass('l-grid3-hd-checker-on');if(isChecked){hd.removeClass('l-grid3-hd-checker-on');this.clearSelections();}else{hd.addClass('l-grid3-hd-checker-on');this.selectAll();}}},renderer:function(v,p,record){return'<div class="l-grid3-row-checker"></div>';}});

L5.grid.RadioboxSelectionModel=L5.extend(L5.grid.RowSelectionModel,{header:"",width:20,sortable:false,menuDisabled:true,singleSelect:true,fixed:true,field:'',id:'radio',initEvents:function(){L5.grid.RadioboxSelectionModel.superclass.initEvents.call(this);this.grid.on('render',function(){var view=this.grid.getView();view.mainBody.on('mousedown',this.onMouseDown,this);},this);},selectFirstRow:function(){var row=this.grid.getView().getRow(0);if(row){var radio=L5.fly(row).child(".l-grid3-row-radio",true);if(radio&&!radio.checked)
radio.checked=true;}
L5.grid.RadioboxSelectionModel.superclass.selectFirstRow.call(this);},onMouseDown:function(e,t){var row=e.getTarget('.l-grid3-row');if(!row)
return;if(e.button===0&&t.className=='l-grid3-row-radio'){e.stopEvent();if(row){var index=row.rowIndex;this.clearSelections();this.selectRow(index,true);}}},renderer:function(v,p,record){return'<input type="radio" name="radioboxcolumn'+arguments[7].getId()+'" class="l-grid3-row-radio" />';}});

L5.sumTextInGrid="";L5.grid.GridSummary=function(config){if(L5.sumTextInGrid!=null){this.sumText=L5.sumTextInGrid;}else{this.sumText='sum';}
L5.apply(this,config);};L5.extend(L5.grid.GridSummary,L5.util.Observable,{decimalPrecision:2,init:function(grid){this.grid=grid;this.cm=grid.getColumnModel();this.view=grid.getView();var v=this.view;v.renderSum=this.renderSum.createDelegate(this);;v.onLayout=function(vw,vh){if(this.renderSum){var sumHeight=this.mainSum.getHeight();this.scroller.setSize(vw,vh-sumHeight);this.mainSum.dom.style.width=vw;}};v.afterMove=function(oldIndex,colIndex){if(this.renderSum){var sumTR=this.view.sumBody;sumTR.dom.cells[oldIndex].swapNode(sumTR.dom.cells[colIndex]);}};v.afterMethod('onColumnWidthUpdated',this.doWidth,this);v.afterMethod('onAllColumnWidthsUpdated',this.doAllWidths,this);v.afterMethod('onColumnHiddenUpdated',this.doHidden,this);v.afterMethod('onUpdate',this.doUpdate,this);v.afterMethod('onRemove',this.doRemove,this);v.afterMethod('onAdd',this.doAdd,this);v.afterMethod('syncHeaderScroll',this.syncSumScroll,v);v.afterMethod('onDataChange',this.refreshSummary,this);if(!this.rowTpl){this.rowTpl=new L5.Template('<div class="l-grid3-summary-row" style="{tstyle}">','<div class="l-grid3-header-offset">','<table class="l-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<tbody><tr>{cells}</tr></tbody>','</table></div></div>');this.rowTpl.disableFormats=true;}
this.rowTpl.compile();if(!this.cellTpl){this.cellTpl=new L5.Template('<td class="l-grid3-col l-grid3-cell l-grid3-td-{id} {css}" style="{style}">','<div class="l-grid3-cell-inner l-grid3-col-{id}" unselectable="on">{value}</div>',"</td>");this.cellTpl.disableFormats=true;}
this.cellTpl.compile();},hideSum:function(visible){var el=this.grid.mainSum;if(el){if(visible===undefined){visible=el.hasClass('l-grid-hide-summary');}
el[visible?'removeClass':'addClass']('l-grid-hide-summary');}},renderSummary:function(o,cs){cs=cs||this.view.getColumnData();var cfg=this.cm.config;var buf=[],c,p={},cf,last=cs.length-1;for(var i=0,len=cs.length;i<len;i++){c=cs[i];cf=cfg[i];p.id=c.id;p.style=c.style;p.css=i==0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':'');if(cf.summaryType||cf.summaryRenderer){if(cf.summaryRenderer)
p.value=(cf.summaryRenderer)(o.data[c.name],p,o);else
p.value=o.data[c.name];}else{p.value=i==0?this.sumText:'';}
if(p.value==undefined||p.value==="")p.value="&#160;";buf[buf.length]=this.cellTpl.apply(p);}
return buf.join('');},calculate:function(rs,cs){var data={},r,c,cfg=this.cm.config,cf;for(var j=0,jlen=rs.length;j<jlen;j++){r=rs[j];for(var i=0,len=cs.length;i<len;i++){c=cs[i];cf=cfg[i];if(cf.summaryType){var floatFlag=false;if((r.data[c.name].toString()).indexOf(".")!=-1){floatFlag=true;}
data[c.name]=L5.grid.GridSummary.Calculations[cf.summaryType](data[c.name]||0,r,c.name,data);if(floatFlag){var ds=parseFloat(String(data[c.name])).toFixed(2);data[c.name]=ds;}}}}
return data;},renderSum:function(){var cs=this.view.getColumnData();var rs=this.grid.dataset.data.items;return this.rowTpl.apply({tstyle:'width:'+this.view.getTotalWidth()+';',cells:this.doRenderSum(rs,cs)});},doRenderSum:function(rs,cs){var data=this.calculate(rs,cs);return this.renderSummary({data:data},cs);},doWidth:function(col,w,tw){this.view.mainSum.dom.firstChild.firstChild.style.width=tw;var sumTR=this.view.sumBody;if(sumTR.dom.cells[col])
sumTR.dom.cells[col].style.width=w;},doAllWidths:function(ws,tw){this.view.mainSum.dom.firstChild.firstChild.style.width=tw;var sumTR=this.view.sumBody;var wlen=ws.length;for(var j=0;j<wlen;j++){if(sumTR.dom.cells[j])
sumTR.dom.cells[j].style.width=ws[j];}},doHidden:function(col,hidden,tw){this.view.mainSum.dom.firstChild.style.width=tw;var sumTR=this.view.sumBody,s,display=hidden?'none':'';sumTR.dom.cells[col].style.display=display;},refreshSummary:function(){var html=this.renderSum();var index=html.indexOf('>');var first=html.substr(index+1);var finalHtml=first.substr(0,first.length-6);this.view.mainSum.dom.innerHTML=finalHtml;this.view.sumBody=new L5.Element(this.view.mainSum.dom.firstChild.firstChild.rows[0]);return true;},doUpdate:function(ds,record){this.refreshSummary();},doRemove:function(ds,record,index,isUpdate){if(!isUpdate){this.refreshSummary();}},doAdd:function(ds,records,index){this.refreshSummary();},syncSumScroll:function(){var mb=this.scroller.dom;this.mainSum.dom.scrollLeft=mb.scrollLeft;this.mainSum.dom.scrollLeft=mb.scrollLeft;}});L5.grid.GridSummary.Calculations={'sum':function(v,record,field){if((record.data[field].toString()).indexOf('.')!=-1){var value=parseFloat(parseFloat(record.data[field]).toFixed(2));var vv=parseFloat(parseFloat(v).toFixed(2));var result=parseFloat(parseFloat(vv+(value||0)).toFixed(2));return result;}else{return v+(record.data[field]||0);}},'count':function(v,record,field,data){return data[field+'count']?++data[field+'count']:(data[field+'count']=1);},'max':function(v,record,field,data){var v=record.data[field];var max=data[field+'max']===undefined?(data[field+'max']=v):data[field+'max'];return v>max?(data[field+'max']=v):max;},'min':function(v,record,field,data){var v=record.data[field];var min=data[field+'min']===undefined?(data[field+'min']=v):data[field+'min'];return v<min?(data[field+'min']=v):min;},'average':function(v,record,field,data){var c=data[field+'count']?++data[field+'count']:(data[field+'count']=1);var t=(data[field+'total']=((data[field+'total']||0)+(record.data[field]||0)));return t===0?0:t/c;}}

L5.ns('L5.ux.grid');if(L5.isWebKit){L5.grid.GridView.prototype.borderWidth=0;}
L5.ux.grid.ColumnHeaderGroup=L5.extend(L5.util.Observable,{constructor:function(config){this.config=config;},init:function(grid){L5.applyIf(grid.colModel,this.config);L5.apply(grid.getView(),this.viewConfig);},viewConfig:{initTemplates:function(){this.constructor.prototype.initTemplates.apply(this,arguments);var ts=this.templates||{};if(!ts.gcell){ts.gcell=new L5.XTemplate('<td colspan="{colspan}" class="l-grid3-hd l-grid3-gcell l-grid3-td-{id} ux-grid-hd-group-row-{row} {cls}" style="{style}">','<div {tooltip} class="l-grid3-hd-inner l-grid3-hd-{id}" unselectable="on" style="{istyle}">{value}</div></td>');}
if(!ts.headers){ts.headers=new L5.Template('<table border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<thead>{rows}</thead>',"</table>");}
ts.hcell=new L5.Template('<td rowspan="{rowspan}" class="l-grid3-hd l-grid3-cell l-grid3-td-{id} {css}" style="{style}"><div {tooltip} {attr} class="l-grid3-hd-inner l-grid3-hd-{id}" unselectable="on" style="{istyle}">',this.grid.enableHdMenu?'<a class="l-grid3-hd-btn" href="#"></a>':'','{value}<img class="l-grid3-sort-icon" src="',L5.BLANK_IMAGE_URL,'" />',"</div></td>");this.templates=ts;this.hrowRe=new RegExp("ux-grid-hd-group-row-(\\d+)","");},renderHeaders:function(){var cm=this.cm,rows=cm.rows,ts=this.templates;var ct=ts.hcell;var len=cm.getColumnCount();var rowstring=[],used=[];var length=rows.length;var last=len-1;for(var j=0;j<length;j++){var row=rows[j];var cb=[];for(var k=0;k<row.length;k++){var p={};var cell=row[k];var i;if(k==0){i=0;}else{i=row[k-1].start+row[k-1].colspan;}
for(;i<cell.start;i++){if(used.indexOf(i)==-1){p.id=cm.getColumnId(i);p.rowspan=length-j+1;p.value=cm.getColumnHeader(i)||"";p.style=this.getColumnStyle(i,true);p.tooltip=this.getColumnTooltip(i);p.css=i==0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':'');if(cm.config[i].align=='right'){p.istyle='padding-right:16px';}else{delete p.istyle;}
used[used.length]=i;cb[cb.length]=ct.apply(p);}}
cell.colspan=cell.colspan||1;cb[cb.length]=ts.gcell.apply({cls:'ux-grid-hd-group-cell',id:k,row:k,colspan:cell.colspan,style:(cell.align?'text-align:'+cell.align+';':'text-align:center;'),tooltip:cell.tooltip?(L5.QuickTips.isEnabled()?'L5:qtip':'title')+'="'+cell.tooltip+'"':'',istyle:cell.align=='right'?'padding-right:16px':'',value:cell.header||'&nbsp;'});}
rowstring[rowstring.length]='<tr class="l-grid3-hd-row">'+cb.join("")+'</tr>';}
var cb=[];for(var i=0;i<len;i++){cm.setFixed(i);if(used.indexOf(i)==-1){p.id=cm.getColumnId(i);p.value=cm.getColumnHeader(i)||"";p.style=this.getColumnStyle(i,true);p.tooltip=this.getColumnTooltip(i);p.css=i==0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':'');if(cm.config[i].align=='right'){p.istyle='padding-right:16px';}else{delete p.istyle;}
cb[cb.length]=ct.apply(p);}}
rowstring[rowstring.length]='<tr class="l-grid3-hd-row">'+cb.join("")+'</tr>';return ts.headers.apply({rows:rowstring.join(""),tstyle:'table-layout:auto;width:'+this.getTotalWidth()+';'});},getHeaderCell:function(index){return this.mainHd.query(this.cellSelector)[index];},findHeaderCell:function(el){return el?this.fly(el).findParent('td.l-grid3-hd',this.cellSelectorDepth):false;},findHeaderIndex:function(el){var cell=this.findHeaderCell(el);return cell?this.getCellIndex(cell):false;},updateSortIcon:function(col,dir){var sc=this.sortClasses,hds=this.mainHd.select(this.cellSelector).removeClass(sc);hds.item(col).addClass(sc[dir=="DESC"?1:0]);},handleHdOver:function(e,t){return;},onHeaderClick:function(g,index){if(this.headersDisabled||index==-1||!this.cm.isSortable(index)){return;}
g.stopEditing(true);g.dataset.sort(this.cm.getDataIndex(index));},renderUI:function(){this.constructor.prototype.renderUI.apply(this,arguments);L5.apply(this.splitZone,L5.ux.grid.ColumnHeaderGroup.prototype.splitZoneConfig);}},splitZoneConfig:{allowHeaderDrag:function(e){return!e.getTarget(null,null,true).hasClass('ux-grid-hd-group-cell');}}});

L5.ns('L5.ux.grid');L5.ux.grid.LockingGridView=L5.extend(L5.grid.GridView,{lockText:'Lock',unlockText:'Unlock',rowBorderWidth:1,lockedBorderWidth:1,syncHeights:true,initTemplates:function(){var ts=this.templates||{};if(!ts.master){ts.master=new L5.Template('<div class="l-grid3" hidefocus="true">','<div class="l-grid3-locked">','<div class="l-grid3-header"><div class="l-grid3-header-inner"><div class="l-grid3-header-offset" style="{lstyle}">{lockedHeader}</div></div><div class="l-clear"></div></div>','<div class="l-grid3-scroller"><div class="l-grid3-body" style="{lstyle}">{lockedBody}</div><div class="l-grid3-scroll-spacer"></div></div>','</div>','<div class="l-grid3-viewport l-grid3-unlocked">','<div class="l-grid3-header"><div class="l-grid3-header-inner"><div class="l-grid3-header-offset" style="{ostyle}">{header}</div></div><div class="l-clear"></div></div>','<div class="l-grid3-scroller"><div class="l-grid3-body" style="{bstyle}">{body}</div><a href="#" class="l-grid3-focus" tabIndex="-1"></a></div>','</div>','<div class="l-grid3-resize-marker">&#160;</div>','<div class="l-grid3-resize-proxy">&#160;</div>','</div>');}
this.templates=ts;L5.ux.grid.LockingGridView.superclass.initTemplates.call(this);},getEditorParent:function(ed){return this.el.dom;},initElements:function(){var E=L5.Element;var el=this.grid.getGridEl().dom.firstChild;var cs=el.childNodes;this.el=new E(el);this.lockedWrap=new E(cs[0]);this.lockedHd=new E(this.lockedWrap.dom.firstChild);this.lockedInnerHd=this.lockedHd.dom.firstChild;this.lockedScroller=new E(this.lockedWrap.dom.childNodes[1]);this.lockedBody=new E(this.lockedScroller.dom.firstChild);this.mainWrap=new E(cs[1]);this.mainHd=new E(this.mainWrap.dom.firstChild);if(this.grid.hideHeaders){this.lockedHd.setDisplayed(false);this.mainHd.setDisplayed(false);}
this.innerHd=this.mainHd.dom.firstChild;this.offsetHd=this.mainHd.dom.firstChild.firstChild;this.scroller=new E(this.mainWrap.dom.childNodes[1]);if(this.forceFit){this.scroller.setStyle('overflow-x','hidden');}
this.mainBody=new E(this.scroller.dom.firstChild);this.focusEl=new E(this.scroller.dom.childNodes[1]);this.focusEl.swallowEvent('click',true);this.resizeMarker=new E(cs[2]);this.resizeProxy=new E(cs[3]);},getLockedRows:function(){return this.hasRows()?this.lockedBody.dom.childNodes:[];},getLockedRow:function(row){return this.getLockedRows()[row];},getCell:function(row,col){var llen=this.cm.getLockedCount();if(col<llen){return this.getLockedRow(row).getElementsByTagName('td')[col];}
return L5.ux.grid.LockingGridView.superclass.getCell.call(this,row,col-llen);},getHeaderCell:function(index){var llen=this.cm.getLockedCount();if(index<llen){return this.lockedHd.dom.getElementsByTagName('td')[index];}
return L5.ux.grid.LockingGridView.superclass.getHeaderCell.call(this,index-llen);},addRowClass:function(row,cls){var r=this.getLockedRow(row);if(r){this.fly(r).addClass(cls);}
L5.ux.grid.LockingGridView.superclass.addRowClass.call(this,row,cls);},removeRowClass:function(row,cls){var r=this.getLockedRow(row);if(r){this.fly(r).removeClass(cls);}
L5.ux.grid.LockingGridView.superclass.removeRowClass.call(this,row,cls);},removeRow:function(row){L5.removeNode(this.getLockedRow(row));L5.ux.grid.LockingGridView.superclass.removeRow.call(this,row);},removeRows:function(firstRow,lastRow){var bd=this.lockedBody.dom;for(var rowIndex=firstRow;rowIndex<=lastRow;rowIndex++){L5.removeNode(bd.childNodes[firstRow]);}
L5.ux.grid.LockingGridView.superclass.removeRows.call(this,firstRow,lastRow);},syncScroll:function(e){var mb=this.scroller.dom;this.lockedScroller.dom.scrollTop=mb.scrollTop;L5.ux.grid.LockingGridView.superclass.syncScroll.call(this,e);},updateSortIcon:function(col,dir){var sc=this.sortClasses,lhds=this.lockedHd.select('td').removeClass(sc),hds=this.mainHd.select('td').removeClass(sc),llen=this.cm.getLockedCount(),cls=sc[dir=='DESC'?1:0];if(col<llen){lhds.item(col).addClass(cls);}else{hds.item(col-llen).addClass(cls);}},updateAllColumnWidths:function(){var tw=this.getTotalWidth(),clen=this.cm.getColumnCount(),lw=this.getLockedWidth(),llen=this.cm.getLockedCount(),ws=[],len,i;this.updateLockedWidth();for(i=0;i<clen;i++){ws[i]=this.getColumnWidth(i);var hd=this.getHeaderCell(i);hd.style.width=ws[i];}
var lns=this.getLockedRows(),ns=this.getRows(),row,trow,j;for(i=0,len=ns.length;i<len;i++){row=lns[i];row.style.width=lw;if(row.firstChild){row.firstChild.style.width=lw;trow=row.firstChild.rows[0];for(j=0;j<llen;j++){trow.childNodes[j].style.width=ws[j];}}
row=ns[i];row.style.width=tw;if(row.firstChild){row.firstChild.style.width=tw;trow=row.firstChild.rows[0];for(j=llen;j<clen;j++){trow.childNodes[j-llen].style.width=ws[j];}}}
this.onAllColumnWidthsUpdated(ws,tw);this.syncHeaderHeight();},updateColumnWidth:function(col,width){var w=this.getColumnWidth(col),llen=this.cm.getLockedCount(),ns,rw,c,row;this.updateLockedWidth();if(col<llen){ns=this.getLockedRows();rw=this.getLockedWidth();c=col;}else{ns=this.getRows();rw=this.getTotalWidth();c=col-llen;}
var hd=this.getHeaderCell(col);hd.style.width=w;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=rw;if(row.firstChild){row.firstChild.style.width=rw;row.firstChild.rows[0].childNodes[c].style.width=w;}}
this.onColumnWidthUpdated(col,w,this.getTotalWidth());this.syncHeaderHeight();},updateColumnHidden:function(col,hidden){var llen=this.cm.getLockedCount(),ns,rw,c,row,display=hidden?'none':'';this.updateLockedWidth();if(col<llen){ns=this.getLockedRows();rw=this.getLockedWidth();c=col;}else{ns=this.getRows();rw=this.getTotalWidth();c=col-llen;}
var hd=this.getHeaderCell(col);hd.style.display=display;for(var i=0,len=ns.length;i<len;i++){row=ns[i];row.style.width=rw;if(row.firstChild){row.firstChild.style.width=rw;row.firstChild.rows[0].childNodes[c].style.display=display;}}
this.onColumnHiddenUpdated(col,hidden,this.getTotalWidth());delete this.lastViewWidth;this.layout();},doRender:function(cs,rs,ds,startRow,colCount,stripe){var ts=this.templates,ct=ts.cell,rt=ts.row,last=colCount-1,tstyle='width:'+this.getTotalWidth()+';',lstyle='width:'+this.getLockedWidth()+';',buf=[],lbuf=[],cb,lcb,c,p={},rp={},r;for(var j=0,len=rs.length;j<len;j++){r=rs[j];cb=[];lcb=[];var rowIndex=(j+startRow);for(var i=0;i<colCount;i++){c=cs[i];p.id=c.id;p.css=(i===0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':''))+
(this.cm.config[i].cellCls?' '+this.cm.config[i].cellCls:'');p.attr=p.cellAttr='';p.value=c.renderer(r.data[c.name],p,r,rowIndex,i,ds,c.name,this.grid);p.style=c.style;if(L5.isEmpty(p.value)){p.value='&#160;';}
if(this.markDirty&&r.dirty&&L5.isDefined(r.modified[c.name])){p.css+=' l-grid3-dirty-cell';}
if(c.locked){lcb[lcb.length]=ct.apply(p);}else{cb[cb.length]=ct.apply(p);}}
var alt=[];if(stripe&&((rowIndex+1)%2===0)){alt[0]='l-grid3-row-alt';}
if(r.dirty){alt[1]=' l-grid3-dirty-row';}
rp.cols=colCount;if(this.getRowClass){alt[2]=this.getRowClass(r,rowIndex,rp,ds);}
rp.alt=alt.join(' ');rp.cells=cb.join('');rp.tstyle=tstyle;buf[buf.length]=rt.apply(rp);rp.cells=lcb.join('');rp.tstyle=lstyle;lbuf[lbuf.length]=rt.apply(rp);}
return[buf.join(''),lbuf.join('')];},processRows:function(startRow,skipStripe){if(!this.ds||this.ds.getCount()<1){return;}
var rows=this.getRows(),lrows=this.getLockedRows(),row,lrow;skipStripe=skipStripe||!this.grid.stripeRows;startRow=startRow||0;for(var i=0,len=rows.length;i<len;++i){row=rows[i];lrow=lrows[i];row.rowIndex=i;lrow.rowIndex=i;if(!skipStripe){row.className=row.className.replace(this.rowClsRe,' ');lrow.className=lrow.className.replace(this.rowClsRe,' ');if((idx+1)%2===0){row.className+=' l-grid3-row-alt';lrow.className+=' l-grid3-row-alt';}}
if(this.syncHeights){var el1=L5.get(row),el2=L5.get(lrow),h1=el1.getHeight(),h2=el2.getHeight();if(h1>h2){el2.setHeight(h1);}else if(h2>h1){el1.setHeight(h2);}}}
if(startRow===0){L5.fly(rows[0]).addClass(this.firstRowCls);L5.fly(lrows[0]).addClass(this.firstRowCls);}
L5.fly(rows[rows.length-1]).addClass(this.lastRowCls);L5.fly(lrows[lrows.length-1]).addClass(this.lastRowCls);},afterRender:function(){if(!this.ds||!this.cm){return;}
var bd=this.renderRows()||['&#160;','&#160;'];this.mainBody.dom.innerHTML=bd[0];this.lockedBody.dom.innerHTML=bd[1];this.processRows(0,true);if(this.deferEmptyText!==true){this.applyEmptyText();}},renderUI:function(){var header=this.renderHeaders();var body=this.templates.body.apply({rows:'&#160;'});var html=this.templates.master.apply({body:body,header:header[0],ostyle:'width:'+this.getOffsetWidth()+';',bstyle:'width:'+this.getTotalWidth()+';',lockedBody:body,lockedHeader:header[1],lstyle:'width:'+this.getLockedWidth()+';'});var g=this.grid;g.getGridEl().dom.innerHTML=html;this.initElements();L5.fly(this.innerHd).on('click',this.handleHdDown,this);L5.fly(this.lockedInnerHd).on('click',this.handleHdDown,this);this.mainHd.on({scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut,mousemove:this.handleHdMove});this.lockedHd.on({scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut,mousemove:this.handleHdMove});this.scroller.on('scroll',this.syncScroll,this);if(g.enableColumnResize!==false){this.splitZone=new L5.grid.GridView.SplitDragZone(g,this.mainHd.dom);this.splitZone.setOuterHandleElId(L5.id(this.lockedHd.dom));this.splitZone.setOuterHandleElId(L5.id(this.mainHd.dom));}
if(g.enableColumnMove){this.columnDrag=new L5.grid.GridView.ColumnDragZone(g,this.innerHd);this.columnDrag.setOuterHandleElId(L5.id(this.lockedInnerHd));this.columnDrag.setOuterHandleElId(L5.id(this.innerHd));this.columnDrop=new L5.grid.HeaderDropZone(g,this.mainHd.dom);}
if(g.enableHdMenu!==false){this.hmenu=new L5.menu.Menu({id:g.id+'-hctx'});this.hmenu.add({itemId:'asc',text:this.sortAscText,cls:'xg-hmenu-sort-asc'},{itemId:'desc',text:this.sortDescText,cls:'xg-hmenu-sort-desc'});if(this.grid.enableColLock!==false){this.hmenu.add('-',{itemId:'lock',text:this.lockText,cls:'xg-hmenu-lock'},{itemId:'unlock',text:this.unlockText,cls:'xg-hmenu-unlock'});}
if(g.enableColumnHide!==false){this.colMenu=new L5.menu.Menu({id:g.id+'-hcols-menu'});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add('-',{itemId:'columns',hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:'l-cols-icon'});}
this.hmenu.on('itemclick',this.handleHdMenuClick,this);}
if(g.trackMouseOver){this.mainBody.on({scope:this,mouseover:this.onRowOver,mouseout:this.onRowOut});this.lockedBody.on({scope:this,mouseover:this.onRowOver,mouseout:this.onRowOut});}
if(g.enableDragDrop||g.enableDrag){this.dragZone=new L5.grid.GridDragZone(g,{ddGroup:g.ddGroup||'GridDD'});}
this.updateHeaderSortState();},layout:function(){if(!this.mainBody){return;}
var g=this.grid;var c=g.getGridEl();var csize=c.getSize(true);var vw=csize.width;if(!g.hideHeaders&&(vw<20||csize.height<20)){return;}
this.syncHeaderHeight();if(g.autoHeight){this.scroller.dom.style.overflow='visible';this.lockedScroller.dom.style.overflow='visible';if(L5.isWebKit){this.scroller.dom.style.position='static';this.lockedScroller.dom.style.position='static';}}else{this.el.setSize(csize.width,csize.height);var hdHeight=this.mainHd.getHeight();var vh=csize.height-(hdHeight);}
this.updateLockedWidth();if(this.forceFit){if(this.lastViewWidth!=vw){this.fitColumns(false,false);this.lastViewWidth=vw;}}else{this.autoExpand();this.syncHeaderScroll();}
this.onLayout(vw,vh);},getOffsetWidth:function(){return(this.cm.getTotalWidth()-this.cm.getTotalLockedWidth()+this.getScrollOffset())+'px';},getScrollOffset:function(){return L5.num(this.scrollOffset,L5.getScrollBarWidth());},renderHeaders:function(){var cm=this.cm,ts=this.templates,ct=ts.hcell,cb=[],lcb=[],p={},len=cm.getColumnCount(),last=len-1;for(var i=0;i<len;i++){p.id=cm.getColumnId(i);p.value=cm.getColumnHeader(i)||'';p.style=this.getColumnStyle(i,true);p.tooltip=this.getColumnTooltip(i);p.css=(i===0?'l-grid3-cell-first ':(i==last?'l-grid3-cell-last ':''))+
(cm.config[i].headerCls?' '+cm.config[i].headerCls:'');if(cm.config[i].align=='right'){p.istyle='padding-right:16px';}else{delete p.istyle;}
if(cm.isLocked(i)){lcb[lcb.length]=ct.apply(p);}else{cb[cb.length]=ct.apply(p);}}
return[ts.header.apply({cells:cb.join(''),tstyle:'width:'+this.getTotalWidth()+';'}),ts.header.apply({cells:lcb.join(''),tstyle:'width:'+this.getLockedWidth()+';'})];},updateHeaders:function(){var hd=this.renderHeaders();this.innerHd.firstChild.innerHTML=hd[0];this.innerHd.firstChild.style.width=this.getOffsetWidth();this.innerHd.firstChild.firstChild.style.width=this.getTotalWidth();this.lockedInnerHd.firstChild.innerHTML=hd[1];var lw=this.getLockedWidth();this.lockedInnerHd.firstChild.style.width=lw;this.lockedInnerHd.firstChild.firstChild.style.width=lw;},getResolvedXY:function(resolved){if(!resolved){return null;}
var c=resolved.cell,r=resolved.row;return c?L5.fly(c).getXY():[this.scroller.getX(),L5.fly(r).getY()];},syncFocusEl:function(row,col,hscroll){L5.ux.grid.LockingGridView.superclass.syncFocusEl.call(this,row,col,col<this.cm.getLockedCount()?false:hscroll);},ensureVisible:function(row,col,hscroll){return L5.ux.grid.LockingGridView.superclass.ensureVisible.call(this,row,col,col<this.cm.getLockedCount()?false:hscroll);},insertRows:function(dm,firstRow,lastRow,isUpdate){var last=dm.getCount()-1;if(!isUpdate&&firstRow===0&&lastRow>=last){this.refresh();}else{if(!isUpdate){this.fireEvent('beforerowsinserted',this,firstRow,lastRow);}
var html=this.renderRows(firstRow,lastRow),before=this.getRow(firstRow);if(before){if(firstRow===0){this.removeRowClass(0,this.firstRowCls);}
L5.DomHelper.insertHtml('beforeBegin',before,html[0]);before=this.getLockedRow(firstRow);L5.DomHelper.insertHtml('beforeBegin',before,html[1]);}else{this.removeRowClass(last-1,this.lastRowCls);L5.DomHelper.insertHtml('beforeEnd',this.mainBody.dom,html[0]);L5.DomHelper.insertHtml('beforeEnd',this.lockedBody.dom,html[1]);}
if(!isUpdate){this.fireEvent('rowsinserted',this,firstRow,lastRow);this.processRows(firstRow);}else if(firstRow===0||firstRow>=last){this.addRowClass(firstRow,firstRow===0?this.firstRowCls:this.lastRowCls);}}
this.syncFocusEl(firstRow);},getColumnStyle:function(col,isHeader){var style=!isHeader?this.cm.config[col].cellStyle||this.cm.config[col].css||'':this.cm.config[col].headerStyle||'';style+='width:'+this.getColumnWidth(col)+';';if(this.cm.isHidden(col)){style+='display:none;';}
var align=this.cm.config[col].align;if(align){style+='text-align:'+align+';';}
return style;},getLockedWidth:function(){return this.cm.getTotalLockedWidth()+'px';},getTotalWidth:function(){return(this.cm.getTotalWidth()-this.cm.getTotalLockedWidth())+'px';},getColumnData:function(){var cs=[],cm=this.cm,colCount=cm.getColumnCount();for(var i=0;i<colCount;i++){var name=cm.getDataIndex(i);cs[i]={name:(!L5.isDefined(name)?this.ds.fields.get(i).name:name),renderer:cm.getRenderer(i),id:cm.getColumnId(i),style:this.getColumnStyle(i),locked:cm.isLocked(i)};}
return cs;},renderBody:function(){var markup=this.renderRows()||['&#160;','&#160;'];return[this.templates.body.apply({rows:markup[0]}),this.templates.body.apply({rows:markup[1]})];},refreshRow:function(record){L5.ux.grid.LockingGridView.superclass.refreshRow.call(this,record);var index=L5.num(record,this.ds.indexOf(record));this.getLockedRow(index).rowIndex=index;},refresh:function(headersToo){this.fireEvent('beforerefresh',this);this.grid.stopEditing(true);var result=this.renderBody();this.mainBody.update(result[0]).setWidth(this.getTotalWidth());this.lockedBody.update(result[1]).setWidth(this.getLockedWidth());if(headersToo===true){this.updateHeaders();this.updateHeaderSortState();}
this.processRows(0,true);this.layout();this.applyEmptyText();this.fireEvent('refresh',this);},onDenyColumnLock:function(){},initData:function(ds,cm){if(this.cm){this.cm.un('columnlockchange',this.onColumnLock,this);}
L5.ux.grid.LockingGridView.superclass.initData.call(this,ds,cm);if(this.cm){this.cm.on('columnlockchange',this.onColumnLock,this);}},onColumnLock:function(){this.refresh(true);},handleHdMenuClick:function(item){var index=this.hdCtxIndex,cm=this.cm,id=item.getItemId(),llen=cm.getLockedCount();switch(id){case'lock':if(cm.getColumnCount(true)<=llen+1){this.onDenyColumnLock();return;}
if(llen!=index){cm.setLocked(index,true,true);cm.moveColumn(index,llen);this.grid.fireEvent('columnmove',index,llen);}else{cm.setLocked(index,true);}
break;case'unlock':if(llen-1!=index){cm.setLocked(index,false,true);cm.moveColumn(index,llen-1);this.grid.fireEvent('columnmove',index,llen-1);}else{cm.setLocked(index,false);}
break;default:return L5.ux.grid.LockingGridView.superclass.handleHdMenuClick.call(this,item);}
return true;},handleHdDown:function(e,t){L5.ux.grid.LockingGridView.superclass.handleHdDown.call(this,e,t);if(this.grid.enableColLock!==false){if(L5.fly(t).hasClass('l-grid3-hd-btn')){var hd=this.findHeaderCell(t),index=this.getCellIndex(hd),ms=this.hmenu.items,cm=this.cm;ms.get('lock').setDisabled(cm.isLocked(index));ms.get('unlock').setDisabled(!cm.isLocked(index));}}},syncHeaderHeight:function(){this.innerHd.firstChild.firstChild.style.height='auto';this.lockedInnerHd.firstChild.firstChild.style.height='auto';var hd=this.innerHd.firstChild.firstChild.offsetHeight,lhd=this.lockedInnerHd.firstChild.firstChild.offsetHeight,height=(lhd>hd?lhd:hd)+'px';this.innerHd.firstChild.firstChild.style.height=height;this.lockedInnerHd.firstChild.firstChild.style.height=height;},updateLockedWidth:function(){var lw=this.cm.getTotalLockedWidth(),tw=this.cm.getTotalWidth()-lw,csize=this.grid.getGridEl().getSize(true),lp=L5.isBorderBox?0:this.lockedBorderWidth,rp=L5.isBorderBox?0:this.rowBorderWidth,vw=(csize.width-lw-lp-rp)+'px',so=this.getScrollOffset();if(!this.grid.autoHeight){var vh=(csize.height-this.mainHd.getHeight())+'px';this.lockedScroller.dom.style.height=vh;this.scroller.dom.style.height=vh;}
this.lockedWrap.dom.style.width=(lw+rp)+'px';this.scroller.dom.style.width=vw;this.mainWrap.dom.style.left=(lw+lp+rp)+'px';if(this.innerHd){this.lockedInnerHd.firstChild.style.width=lw+'px';this.lockedInnerHd.firstChild.firstChild.style.width=lw+'px';this.innerHd.style.width=vw;this.innerHd.firstChild.style.width=(tw+rp+so)+'px';this.innerHd.firstChild.firstChild.style.width=tw+'px';}
if(this.mainBody){this.lockedBody.dom.style.width=(lw+rp)+'px';this.mainBody.dom.style.width=(tw+rp)+'px';}}});L5.ux.grid.LockingColumnModel=L5.extend(L5.grid.ColumnModel,{isLocked:function(colIndex){return this.config[colIndex].locked===true;},setConfig:function(config,initial){var locked=[];var unlocked=[];for(var i=0;i<config.length;i++){if(config[i].locked){locked[locked.length]=config[i];}else{unlocked[unlocked.length]=config[i];}}
config=locked.concat(unlocked);L5.ux.grid.LockingColumnModel.superclass.setConfig.call(this,config,initial);},setLocked:function(colIndex,value,suppressEvent){if(this.isLocked(colIndex)==value){return;}
this.config[colIndex].locked=value;if(!suppressEvent){this.fireEvent('columnlockchange',this,colIndex,value);}},getTotalLockedWidth:function(){var totalWidth=0;for(var i=0,len=this.config.length;i<len;i++){if(this.isLocked(i)&&!this.isHidden(i)){totalWidth+=this.getColumnWidth(i);}}
return totalWidth;},getLockedCount:function(){for(var i=0,len=this.config.length;i<len;i++){if(!this.isLocked(i)){return i;}}},moveColumn:function(oldIndex,newIndex){if(oldIndex<newIndex&&this.isLocked(oldIndex)&&!this.isLocked(newIndex)){this.setLocked(oldIndex,false,true);}else if(oldIndex>newIndex&&!this.isLocked(oldIndex)&&this.isLocked(newIndex)){this.setLocked(oldIndex,true,true);}
L5.ux.grid.LockingColumnModel.superclass.moveColumn.apply(this,arguments);}});

L5.grid.GroupingView=L5.extend(L5.grid.GridView,{hideGroupedColumn:false,showGroupName:true,startCollapsed:false,enableGrouping:true,enableGroupingMenu:true,enableNoGroups:true,emptyGroupText:'(None)',ignoreAdd:false,groupTextTpl:'{text}',gidSeed:1000,initTemplates:function(){L5.grid.GroupingView.superclass.initTemplates.call(this);this.state={};var sm=this.grid.getSelectionModel();sm.on(sm.selectRow?'beforerowselect':'beforecellselect',this.onBeforeRowSelect,this);if(!this.startGroup){this.startGroup=new L5.XTemplate('<div id="{groupId}" class="l-grid-group {cls}">','<div id="{groupId}-hd" class="l-grid-group-hd" style="{style}"><div>',this.groupTextTpl,'</div></div>','<div id="{groupId}-bd" class="l-grid-group-body">');}
this.startGroup.compile();this.endGroup='</div></div>';},findGroup:function(el){return L5.fly(el).up('.l-grid-group',this.mainBody.dom);},getGroups:function(){return this.hasRows()?this.mainBody.dom.childNodes:[];},onAdd:function(){if(this.enableGrouping&&!this.ignoreAdd){var ss=this.getScrollState();this.refresh();this.restoreScroll(ss);}else if(!this.enableGrouping){L5.grid.GroupingView.superclass.onAdd.apply(this,arguments);}},onRemove:function(ds,record,index,isUpdate){L5.grid.GroupingView.superclass.onRemove.apply(this,arguments);var g=document.getElementById(record._groupId);if(g&&g.childNodes[1].childNodes.length<1){L5.removeNode(g);}
this.applyEmptyText();},refreshRow:function(record){if(this.ds.getCount()==1){this.refresh();}else{this.isUpdating=true;L5.grid.GroupingView.superclass.refreshRow.apply(this,arguments);this.isUpdating=false;}},beforeMenuShow:function(){var field=this.getGroupField();var g=this.hmenu.items.get('groupBy');if(g){g.setDisabled(this.cm.config[this.hdCtxIndex].groupable===false);}
var s=this.hmenu.items.get('showGroups');if(s){s.setDisabled(!field&&this.cm.config[this.hdCtxIndex].groupable===false);s.setChecked(!!field,true);}},renderUI:function(){L5.grid.GroupingView.superclass.renderUI.call(this);this.mainBody.on('mousedown',this.interceptMouse,this);if(this.enableGroupingMenu&&this.hmenu){this.hmenu.add('-',{id:'groupBy',text:this.groupByText,handler:this.onGroupByClick,scope:this,iconCls:'l-group-by-icon'});if(this.enableNoGroups){this.hmenu.add({id:'showGroups',text:this.showGroupsText,checked:true,checkHandler:this.onShowGroupsClick,scope:this});}
this.hmenu.on('beforeshow',this.beforeMenuShow,this);}},onGroupByClick:function(){this.grid.dataset.groupBy(this.cm.getDataIndex(this.hdCtxIndex));this.beforeMenuShow();},onShowGroupsClick:function(mi,checked){if(checked){this.onGroupByClick();}else{this.grid.dataset.clearGrouping();}},toggleGroup:function(group,expanded){this.grid.stopEditing(true);group=L5.getDom(group);var gel=L5.fly(group);expanded=expanded!==undefined?expanded:gel.hasClass('l-grid-group-collapsed');this.state[gel.dom.id]=expanded;gel[expanded?'removeClass':'addClass']('l-grid-group-collapsed');},toggleAllGroups:function(expanded){var groups=this.getGroups();for(var i=0,len=groups.length;i<len;i++){this.toggleGroup(groups[i],expanded);}},expandAllGroups:function(){this.toggleAllGroups(true);},collapseAllGroups:function(){this.toggleAllGroups(false);},interceptMouse:function(e){var hd=e.getTarget('.l-grid-group-hd',this.mainBody);if(hd){e.stopEvent();this.toggleGroup(hd.parentNode);}},getGroup:function(v,r,groupRenderer,rowIndex,colIndex,ds){var g=groupRenderer?groupRenderer(v,{},r,rowIndex,colIndex,ds):String(v);if(g===''){g=this.cm.config[colIndex].emptyGroupText||this.emptyGroupText;}
return g;},getGroupField:function(){return this.grid.dataset.getGroupState();},renderRows:function(){var groupField=this.getGroupField();var eg=!!groupField;if(this.hideGroupedColumn){var colIndex=this.cm.findColumnIndex(groupField);if(!eg&&this.lastGroupField!==undefined){this.mainBody.update('');this.cm.setHidden(this.cm.findColumnIndex(this.lastGroupField),false);delete this.lastGroupField;}else if(eg&&this.lastGroupField===undefined){this.lastGroupField=groupField;this.cm.setHidden(colIndex,true);}else if(eg&&this.lastGroupField!==undefined&&groupField!==this.lastGroupField){this.mainBody.update('');var oldIndex=this.cm.findColumnIndex(this.lastGroupField);this.cm.setHidden(oldIndex,false);this.lastGroupField=groupField;this.cm.setHidden(colIndex,true);}}
return L5.grid.GroupingView.superclass.renderRows.apply(this,arguments);},doRender:function(cs,rs,ds,startRow,colCount,stripe){if(rs.length<1){return'';}
var groupField=this.getGroupField();var colIndex=this.cm.findColumnIndex(groupField);this.enableGrouping=!!groupField;if(!this.enableGrouping||this.isUpdating){return L5.grid.GroupingView.superclass.doRender.apply(this,arguments);}
var gstyle='width:'+this.getTotalWidth()+';';var gidPrefix=this.grid.getGridEl().id;var cfg=this.cm.config[colIndex];var groupRenderer=cfg.groupRenderer||cfg.renderer;var prefix=this.showGroupName?(cfg.groupName||cfg.header)+': ':'';var groups=[],curGroup,i,len,gid;for(i=0,len=rs.length;i<len;i++){var rowIndex=startRow+i;var r=rs[i],gvalue=r.data[groupField],g=this.getGroup(gvalue,r,groupRenderer,rowIndex,colIndex,ds);if(!curGroup||curGroup.group!=g){gid=gidPrefix+'-gp-'+groupField+'-'+L5.util.Format.htmlEncode(g);var isCollapsed=typeof this.state[gid]!=='undefined'?!this.state[gid]:this.startCollapsed;var gcls=isCollapsed?'l-grid-group-collapsed':'';curGroup={group:g,gvalue:gvalue,text:prefix+g,groupId:gid,startRow:rowIndex,rs:[r],cls:gcls,style:gstyle};groups.push(curGroup);}else{curGroup.rs.push(r);}
r._groupId=gid;}
var buf=[];for(i=0,len=groups.length;i<len;i++){var g=groups[i];this.doGroupStart(buf,g,cs,ds,colCount);buf[buf.length]=L5.grid.GroupingView.superclass.doRender.call(this,cs,g.rs,ds,g.startRow,colCount,stripe);this.doGroupEnd(buf,g,cs,ds,colCount);}
return buf.join('');},getGroupId:function(value){var gidPrefix=this.grid.getGridEl().id;var groupField=this.getGroupField();var colIndex=this.cm.findColumnIndex(groupField);var cfg=this.cm.config[colIndex];var groupRenderer=cfg.groupRenderer||cfg.renderer;var gtext=this.getGroup(value,{data:{}},groupRenderer,0,colIndex,this.ds);return gidPrefix+'-gp-'+groupField+'-'+L5.util.Format.htmlEncode(value);},doGroupStart:function(buf,g,cs,ds,colCount){buf[buf.length]=this.startGroup.apply(g);},doGroupEnd:function(buf,g,cs,ds,colCount){buf[buf.length]=this.endGroup;},getRows:function(){if(!this.enableGrouping){return L5.grid.GroupingView.superclass.getRows.call(this);}
var r=[];var g,gs=this.getGroups();for(var i=0,len=gs.length;i<len;i++){g=gs[i].childNodes[1].childNodes;for(var j=0,jlen=g.length;j<jlen;j++){r[r.length]=g[j];}}
return r;},updateGroupWidths:function(){if(!this.enableGrouping||!this.hasRows()){return;}
var tw=Math.max(this.cm.getTotalWidth(),this.el.dom.offsetWidth-this.scrollOffset)+'px';var gs=this.getGroups();for(var i=0,len=gs.length;i<len;i++){gs[i].firstChild.style.width=tw;}},onColumnWidthUpdated:function(col,w,tw){L5.grid.GroupingView.superclass.onColumnWidthUpdated.call(this,col,w,tw);this.updateGroupWidths();},onAllColumnWidthsUpdated:function(ws,tw){L5.grid.GroupingView.superclass.onAllColumnWidthsUpdated.call(this,ws,tw);this.updateGroupWidths();},onColumnHiddenUpdated:function(col,hidden,tw){L5.grid.GroupingView.superclass.onColumnHiddenUpdated.call(this,col,hidden,tw);this.updateGroupWidths();},onLayout:function(){this.updateGroupWidths();},onBeforeRowSelect:function(sm,rowIndex){if(!this.enableGrouping){return;}
var row=this.getRow(rowIndex);if(row&&!row.offsetParent){var g=this.findGroup(row);this.toggleGroup(g,true);}},groupByText:'Group by current text',showGroupsText:'Show groups'});L5.grid.GroupingView.GROUP_ID=1000;
